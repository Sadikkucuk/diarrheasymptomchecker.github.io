<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Free Page Builder — Templates & Drag-Drop</title>
  <meta name="description" content="Şablonlardan ve blok sürükle-bıraktan web sitesi üret. GitHub Pages + Cloudflare Workers." />

  <!-- ZIP export -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js" defer></script>

  <style>
    :root {
      --bg:#0b1020; --panel:#121832; --muted:#a7b5ff;
      --text:#e7ecff; --soft:#1a2246; --accent:#0ea5e9;
      --sel:#22c55e;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial,Noto Sans,sans-serif;background:var(--bg);color:var(--text)}
    a{text-decoration:none}

    .topbar{position:sticky;top:0;z-index:50;display:flex;gap:.75rem;align-items:center;padding:.75rem 1rem;background:#0b1020;border-bottom:1px solid #1d2753}
    .brand{font-weight:800}
    .spacer{flex:1}
    .btn{border:1px solid #2a3a77;background:#121a3a;color:var(--text);padding:.55rem .8rem;border-radius:.6rem;cursor:pointer;font-weight:600}
    .btn:hover{border-color:#3c50a3;background:#16204a}
    .btn.ok{border-color:#1c7a59;background:#0e3e2e}
    .btn.warn{border-color:#7a5a1c;background:#3e2f0e}
    .toolbar select,.toolbar input[type="text"],.toolbar input[type="color"]{background:#0f1735;border:1px solid #2a3a77;color:var(--text);border-radius:.5rem;padding:.5rem .6rem}

    .wrap{display:grid;grid-template-columns:280px 1fr;gap:14px;padding:14px}
    .panel{background:var(--panel);border:1px solid #1d2753;border-radius:14px;padding:12px}

    .palette h3{margin:.25rem 0 .5rem;font-size:1rem;color:var(--muted)}
    .block-card{background:var(--soft);border:1px dashed #2c3a78;border-radius:12px;padding:10px;margin-bottom:10px;cursor:grab}
    .block-card:active{cursor:grabbing}

    .canvas{min-height:50vh;padding:10px;border:2px dashed #2c3a78;border-radius:14px;background:#0e1430}
    .hint{color:#9fb0ff;font-size:.95rem;text-align:center;padding:18px 6px}
    .drop-target{outline:2px dashed var(--accent);outline-offset:2px}

    .placed{position:relative;border:1px solid #2b3a79;border-radius:14px;overflow:hidden;background:#0e1430;margin:10px 0}
    .controls{position:absolute;right:10px;top:10px;display:flex;gap:6px;z-index:10}
    .ctl{font-size:12px;padding:.2rem .45rem;border-radius:8px;border:1px solid #32408a;background:#121a3a;color:var(--text);cursor:pointer}
    .ctl:hover{background:#182456}

    [contenteditable="true"]:focus{outline:2px dashed var(--accent);outline-offset:2px}
    .selected-edit{outline:2px solid var(--sel)!important;outline-offset:2px;border-radius:6px}

    .sticky-footer{position:fixed;left:12px;bottom:12px;background:#0e1430;border:1px solid #1d2753;color:#a8b6ff;padding:10px 12px;border-radius:12px;font-size:.85rem}

    @media (max-width:980px){.wrap{grid-template-columns:1fr}}
  </style>
</head>
<body>
<header class="topbar">
  <div class="brand">Free Page Builder</div>

  <div class="toolbar">
    <label>Şablon:</label>
    <select id="templateSelect"><option>Yükleniyor…</option></select>
  </div>

  <div class="spacer"></div>

  <div class="toolbar">
    <label>Vurgu</label>
    <input id="themeColor" type="color" value="#0ea5e9" title="Accent color" />
    <button id="applyTheme" class="btn">Tema</button>
  </div>

  <div class="toolbar">
    <label>Metin rengi</label>
    <input id="textColor" type="color" value="#ffffff" title="Text color" />
    <select id="colorScope">
      <option value="selection">Seçili</option>
      <option value="block">Blok</option>
      <option value="page">Sayfa</option>
    </select>
    <button id="applyTextColor" class="btn">Uygula</button>
    <button id="resetTextColor" class="btn warn">Sıfırla</button>
  </div>

  <div class="toolbar">
    <input id="siteTitle" type="text" placeholder="Site başlığı (export)" />
    <button id="applyTemplate" class="btn">Uygula</button>
    <button id="save" class="btn">Kaydet</button>
    <button id="load" class="btn">Yükle</button>
    <button id="clear" class="btn warn">Temizle</button>
    <button id="exportZip" class="btn ok">ZIP</button>
  </div>
</header>

<main class="wrap">
  <aside class="panel palette">
    <h3>Bloklar (sürükle-bırak)</h3>
    <div id="palette"></div>
  </aside>

  <section id="canvas" class="panel canvas" aria-label="Drop blocks here" tabindex="0">
    <div id="hint" class="hint">Soldan blokları sürükleyip bırak. Metinlere tıklayıp düzenle. Her görsele tıklayıp değiştir.</div>
  </section>
</main>

<div class="sticky-footer">Tam senin tasarımın, tamamen statik. Giriş gerekmez.</div>

<script>
  // ======== CONFIG ========
  const CF_WORKER_BASE = "https://builder-templates.sadik-kucuk3739342.workers.dev";

  // ======== STATE / DOM ========
  const state = { blocks:{}, templates:[], accent:'#0ea5e9' };
  const palette = document.getElementById('palette');
  const canvas = document.getElementById('canvas');
  const templateSelect = document.getElementById('templateSelect');
  const hint = document.getElementById('hint');
  let selectedEditable = null;

  // Utils
  const esc = s => String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));

  // High-contrast rule: hiçbir şablonda pastel/soluk arka plan yok (bunu Worker tarafında da yaptık)

  // Tema (vurgu rengi)
  document.getElementById('applyTheme').addEventListener('click', ()=>{
    const c = document.getElementById('themeColor').value || '#0ea5e9';
    state.accent = c;
    document.documentElement.style.setProperty('--accent', c);
  });

  // Metin rengi — seçili/blok/sayfa
  document.getElementById('applyTextColor').addEventListener('click', ()=>{
    const color = document.getElementById('textColor').value || '#ffffff';
    const scope = document.getElementById('colorScope').value;
    applyColor(scope, color);
  });
  document.getElementById('resetTextColor').addEventListener('click', ()=>{
    const scope = document.getElementById('colorScope').value;
    applyColor(scope, null); // remove color
  });

  function applyColor(scope, color){
    const setColor = el => {
      if (color) el.style.color = color;
      else el.style.removeProperty('color');
    };

    if (scope === 'selection') {
      if (!selectedEditable) return alert('Önce düzenlenecek metni seç.');
      setColor(selectedEditable);
      return;
    }
    if (scope === 'block') {
      if (!selectedEditable) return alert('Önce bir blok içindeki metni seç.');
      const blk = selectedEditable.closest('.placed');
      blk.querySelectorAll('[data-edit]').forEach(setColor);
      return;
    }
    // page
    canvas.querySelectorAll('[data-edit]').forEach(setColor);
  }

  // Seçim: herhangi bir [data-edit] tıklanınca seç
  canvas.addEventListener('click', (e)=>{
    const target = e.target.closest('[data-edit]');
    if (target) {
      if (selectedEditable) selectedEditable.classList.remove('selected-edit');
      selectedEditable = target;
      selectedEditable.classList.add('selected-edit');
    }
  });

  // Her görsel ayrı değiştirilebilsin: herhangi bir img veya [data-img] tıklaması
  canvas.addEventListener('click', (e)=>{
    const img = e.target.closest('img,[data-img]');
    if (!img) return;
    if (!img.closest('.placed')) return; // palet değil, canvas içi
    e.preventDefault();
    e.stopPropagation();
    replaceImageTarget(img);
  });

function addBlock(blockId, htmlOverride) {
  const def = state.blocks[blockId];
  if (!def) return;
  hint.style.display = 'none';

  const wrapper = document.createElement('section');
  wrapper.className = 'placed';
  wrapper.dataset.blockId = blockId;

  const controls = document.createElement('div');
  controls.className = 'controls';
  controls.innerHTML = `
    <button class="ctl" title="Yukarı">↑</button>
    <button class="ctl" title="Aşağı">↓</button>
    <button class="ctl" title="Kopya">⎘</button>
    <button class="ctl" title="Sil">✕</button>
  `;
  controls.addEventListener('click', (e)=>{
    const b = e.target.closest('button.ctl'); if(!b) return;
    if (b.title === 'Sil') wrapper.remove();
    if (b.title === 'Kopya') wrapper.after(wrapper.cloneNode(true));
    if (b.title === 'Yukarı') wrapper.previousElementSibling?.before(wrapper);
    if (b.title === 'Aşağı') wrapper.nextElementSibling?.after(wrapper);
  });

  // *** SADECE İÇERİK BURADA ***
const content = document.createElement('div');
content.className = 'content';
content.innerHTML = htmlOverride || def.html;

// Tüm düzenlenebilirleri aktif et + link tıklamasını engelle
content.querySelectorAll('[data-edit]').forEach(el=>{
  el.setAttribute('contenteditable','true');
  el.addEventListener('click', ev=>{
    const a = ev.target.closest('a');
    if (a) ev.preventDefault();          // # linki tepmesin, metni düzenleyebilelim
    selectedEditable = ev.target.closest('[data-edit]');
    document.querySelectorAll('.selected-edit').forEach(n=>n.classList.remove('selected-edit'));
    selectedEditable?.classList.add('selected-edit');
  });
});

// Bloktaki tüm img'ler değiştirilebilir olsun
content.querySelectorAll('img').forEach(n=> n.setAttribute('data-img',''));

  // tüm img’ler değiştirilebilir olsun
  content.querySelectorAll('img').forEach(n=> n.setAttribute('data-img',''));

  wrapper.append(controls, content);
  canvas.appendChild(wrapper);
}

function applyColor(scope, color){
  const set = el => color ? (el.style.color = color) : el.style.removeProperty('color');

  if (scope === 'selection') {
    if (!selectedEditable) return alert('Önce düzenlenecek metni seç.');
    set(selectedEditable); return;
  }
  if (scope === 'block') {
    if (!selectedEditable) return alert('Önce blok içinden bir metin seç.');
    selectedEditable.closest('.placed').querySelectorAll('[data-edit]').forEach(set); return;
  }
  // page
  canvas.querySelectorAll('[data-edit]').forEach(set);
}

// UI butonları
document.getElementById('applyTextColor')?.addEventListener('click', ()=>{
  const color = document.getElementById('textColor').value || '#000000';
  const scope = document.getElementById('colorScope').value || 'selection';
  applyColor(scope, color);
});
document.getElementById('resetTextColor')?.addEventListener('click', ()=>{
  const scope = document.getElementById('colorScope').value || 'selection';
  applyColor(scope, null);
});

  
function replaceImage(wrapper){
  const imgs = Array.from(wrapper.querySelectorAll('[data-img], img'));
  if (!imgs.length) return alert('Bu blokta görsel yok.');
  let target = imgs[0];
  if (imgs.length > 1) {
    const ans = prompt(`Hangi görsel? 1-${imgs.length} (hepsi için A yaz)`, "1");
    if (!ans) return;
    if (ans.toLowerCase?.() === 'a') { imgs.forEach(el => promptAndSetImage(el)); return; }
    const i = Math.max(1, Math.min(imgs.length, parseInt(ans,10) || 1));
    target = imgs[i-1];
  }
  promptAndSetImage(target);
}
function promptAndSetImage(target){
  const url = prompt('Görsel URL (boş bırak -> dosya yükle):');
  if (url) { target.setAttribute('src', url); return; }
  const input = document.createElement('input');
  input.type = 'file'; input.accept = 'image/*';
  input.onchange = () => {
    const f = input.files?.[0]; if (!f) return;
    const fr = new FileReader();
    fr.onload = () => target.setAttribute('src', fr.result);
    fr.readAsDataURL(f);
  };
  input.click();
}

  
  function replaceImageTarget(target){
    const url = prompt('Görsel URL yapıştır (ya da boş bırakıp dosya yükle):');
    if (url) { target.setAttribute('src', url); return; }
    const input = document.createElement('input');
    input.type = 'file'; input.accept = 'image/*';
    input.onchange = () => {
      const f = input.files?.[0]; if (!f) return;
      const fr = new FileReader();
      fr.onload = () => target.setAttribute('src', fr.result);
      fr.readAsDataURL(f);
    };
    input.click();
  }

  // Şablonları çek
  bootstrap();
  async function bootstrap(){
    try{
      const res = await fetch(`${CF_WORKER_BASE}/templates`, {mode:'cors'});
      if(!res.ok) throw new Error(res.status);
      const data = await res.json();
      hydrateUI(data);
    }catch(e){
      alert('Şablon servisine ulaşılamadı. Worker URL’ini kontrol et.');
      hydrateUI({blocks:{},templates:[]});
    }
  }

  function hydrateUI(data){
    state.blocks = data.blocks || {};
    state.templates = data.templates || [];

    // Palet
    palette.innerHTML = '';
    Object.values(state.blocks).forEach(b=>{
      const el = document.createElement('div');
      el.className = 'block-card';
      el.draggable = true;
      el.dataset.blockId = b.id;
      el.innerHTML = `<strong>${esc(b.name)}</strong><div style="opacity:.8;font-size:.9em;margin-top:.25rem">${esc(b.id)}</div>`;
      el.addEventListener('dragstart', e=> e.dataTransfer.setData('text/plain', b.id));
      el.addEventListener('dblclick', ()=> addBlock(b.id));
      palette.appendChild(el);
    });

    // Şablon seçimi
    document.getElementById('templateSelect').innerHTML =
      state.templates.map(t=>`<option value="${esc(t.id)}">${esc(t.name)}</option>`).join('');
  }

  // Canvas DnD
  canvas.addEventListener('dragover', e=>{e.preventDefault(); canvas.classList.add('drop-target')});
  canvas.addEventListener('dragleave', ()=> canvas.classList.remove('drop-target'));
  canvas.addEventListener('drop', e=>{
    e.preventDefault(); canvas.classList.remove('drop-target');
    const id = e.dataTransfer.getData('text/plain');
    if (id) addBlock(id);
  });

  function serializeCanvasToHTML(){
  const parts = [];
  canvas.querySelectorAll('.placed > .content').forEach(node=>{
    const clone = node.cloneNode(true);
    // editöre özel şeyleri temizle
    clone.querySelectorAll('[contenteditable]').forEach(el=>el.removeAttribute('contenteditable'));
    clone.querySelectorAll('[data-edit]').forEach(el=>el.removeAttribute('data-edit'));
    clone.querySelectorAll('[data-img]').forEach(el=>el.removeAttribute('data-img'));
    clone.querySelectorAll('.selected-edit').forEach(el=>el.classList.remove('selected-edit'));
    parts.push(clone.innerHTML);
  });
  return parts.join('\n\n');
}

  // Blok ekle
  function addBlock(blockId, htmlOverride){
    const def = state.blocks[blockId];
    if (!def) return;
    hint.style.display = 'none';

    const wrapper = document.createElement('section');
    wrapper.className = 'placed';
    wrapper.dataset.blockId = blockId;

    const controls = document.createElement('div');
    controls.className = 'controls';
    controls.innerHTML = `
      <button class="ctl" title="Yukarı">↑</button>
      <button class="ctl" title="Aşağı">↓</button>
      <button class="ctl" title="Kopya">⎘</button>
      <button class="ctl" title="Sil">✕</button>
    `;
    controls.addEventListener('click', (e)=>{
      const btn = e.target.closest('button.ctl'); if(!btn) return;
      if (btn.title === 'Sil') wrapper.remove();
      if (btn.title === 'Kopya') wrapper.after(wrapper.cloneNode(true));
      if (btn.title === 'Yukarı') wrapper.previousElementSibling?.before(wrapper);
      if (btn.title === 'Aşağı') wrapper.nextElementSibling?.after(wrapper);
    });

const content = document.createElement('div');
content.className = 'content';              // <-- içerik div'i
content.innerHTML = htmlOverride || def.html;

const blocks = Array.from(canvas.querySelectorAll('.placed'))
  .map(sec => sec.querySelector(':scope > .content').innerHTML);

    // Tüm metinler düzenlenebilir + başlangıçta yüksek kontrast
    content.querySelectorAll('h1,h2,h3,h4,h5,h6,p,li,a,strong,em,span,small,button').forEach(n=>{
      n.setAttribute('data-edit','');
      n.style.color = '#0a0a0a'; // yüksek kontrast (sayfa export'unda açık tema)
    });
    // Görsel işaretleri (logolar dahil) — hepsi tıklanarak değişir
    content.querySelectorAll('img').forEach(n=> n.setAttribute('data-img',''));

    wrapper.appendChild(controls);
    wrapper.appendChild(content);
    canvas.appendChild(wrapper);
  }

  // Şablon uygula
  document.getElementById('applyTemplate').addEventListener('click', ()=>{
    const id = templateSelect.value;
    const tpl = state.templates.find(t=> t.id === id);
    if (!tpl) return;
    canvas.innerHTML = '<div id="hint" class="hint" style="display:none"></div>';
    (tpl.blocks||[]).forEach(bid => addBlock(bid));
    selectedEditable = null;
  });

  // Kaydet/Yükle
  document.getElementById('save').addEventListener('click', ()=>{
    const layout = Array.from(canvas.querySelectorAll('.placed')).map(sec=>({
      id: sec.dataset.blockId,
html: sec.querySelector(':scope > .content').innerHTML
    }));
    const data = {
      title: document.getElementById('siteTitle').value || 'Benim Sitem',
      layout,
      accent: state.accent
    };
    localStorage.setItem('builder:v3', JSON.stringify(data));
    alert('Yerelde kaydedildi');
  });

  document.getElementById('load').addEventListener('click', ()=>{
    const raw = localStorage.getItem('builder:v3') || localStorage.getItem('builder:v2') || localStorage.getItem('builder:v1');
    if (!raw) return alert('Kayıt yok');
    const data = JSON.parse(raw);
    document.getElementById('siteTitle').value = data.title || '';
    if (data.accent){
      state.accent = data.accent;
      document.documentElement.style.setProperty('--accent', data.accent);
      document.getElementById('themeColor').value = data.accent;
    }
    canvas.innerHTML = '<div id="hint" class="hint" style="display:none"></div>';
    (data.layout||[]).forEach(item=> addBlock(item.id, item.html));
  });

  document.getElementById('clear').addEventListener('click', ()=>{
    if(!confirm('Canvas temizlensin mi?')) return;
    canvas.innerHTML = '<div id="hint" class="hint">Soldan blokları sürükleyip bırak. Metinlere tıkla ve düzenle. Görsellere tıkla ve değiştir.</div>';
    selectedEditable = null;
  });

  // ZIP export — tam olarak canvas’taki HTML’e göre (YANLIŞ sayfa çıkma problemi burada çözüldü)
document.getElementById('exportZip').addEventListener('click', async ()=>{
  const bodyHtml = serializeCanvasToHTML();
  if (!bodyHtml.trim()) return alert('Önce blok ekle');
  const title  = document.getElementById('siteTitle').value || 'Benim Sitem';
  const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#0ea5e9';
  const html = renderDocument(title, bodyHtml, accent);
  const zip = new JSZip();
  zip.file('index.html', html);
  const blob = await zip.generateAsync({ type:'blob' });
  saveAs(blob, 'site.zip');
});


  function renderDocument(title, bodyHtml, accent){
    // Export edilen sayfa: açık tema, yüksek kontrast (silik renk yok)
    return `<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>${esc(title)}</title>
  <meta name="description" content="Exported static site"/>
  <style>
    :root{--accent:${accent}}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial,Noto Sans,sans-serif;color:#0a0a0a;background:#ffffff}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    a{color:var(--accent)}
    .btn{display:inline-block;background:var(--accent);color:#fff;padding:12px 18px;border-radius:10px;font-weight:700;text-decoration:none}
    img{max-width:100%;height:auto}
  </style>
</head>
<body>
${bodyHtml}
</body>
</html>`;
  }
</script>
</body>
</html>
