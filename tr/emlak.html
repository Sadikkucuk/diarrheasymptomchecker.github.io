<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Miras & Emlak Beyanname Oluşturucu (Tek Sayfa HTML)</title>
  <meta name="description" content="Miras parametreleri, mirasçı pay dağılımı ve Arazi/Arsa/Bina için bireysel emlak beyannamesi PDF üreten tek sayfalık uygulama." />
  <style>
    :root{--bg:#ffffff;--fg:#0b1220;--muted:#6b7280;--line:#e5e7eb;--card:#f8fafc;--accent:#0ea5e9;--danger:#ef4444}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{position:sticky;top:0;background:rgba(255,255,255,.85);backdrop-filter:saturate(1.2) blur(8px);border-bottom:1px solid var(--line)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:20px}
    h2{margin:0 0 8px;font-size:16px}
    h3{margin:0 0 8px;font-size:15px}
    .grid{display:grid;gap:12px}
    .g-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .g-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    @media (max-width: 960px){.g-2,.g-3,.g-4{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    .row{display:flex;gap:8px;align-items:center}
    .spacer{flex:1}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;color:var(--fg)}
    input[type="date"]{padding:8px 10px}
    textarea{min-height:72px}
    button{cursor:pointer;border:1px solid var(--line);background:#fff;color:var(--fg);padding:10px 14px;border-radius:12px}
    .btn{display:inline-flex;align-items:center;gap:8px}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.ghost{background:transparent}
    .btn.danger{border-color:var(--danger);color:var(--danger)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border:1px solid var(--line);border-radius:999px;background:#fff}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--line);padding:6px 8px;text-align:left}
    thead th{background:#eef2f7}
    .right{text-align:right}
    .center{text-align:center}

    .pdf-sheet{background:#fff;border:1px solid var(--line);border-radius:12px;padding:18px}
    .section-title{font-weight:600;margin:8px 0}

    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef6ff;color:#0b5cab;border:1px solid #dbeafe;font-size:12px}
    .tiny{font-size:12px}

    .divider{height:1px;background:var(--line);margin:12px 0}
  </style>
  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNa5H0GyG3mMr7jbp+JtqM5knWj0GqG2QjO1uc8fGx0PrzVBY7v8jI3d9F5Vq+s6wA9KqUo8+5fVb3bqk8NQ0A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-YcsIP8r5c5QZf8y3+UuRupQy0y7pFUnf9dY5YVx0zQyUi5s8b8P3t8WmYw2zY+5Ww8cY8qH1k9q0G5lqYv6Y0w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" integrity="sha512-2Vksm5cwRkWc6nn+Kc6oIy37XcLb3z7b9D4F2Yp9gNCo2od9WuuQK0W0s1YQbWkXjR6c8k6oJcCof4iTn1rG5A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" integrity="sha512-bGv6C3G6Jc5eH9y6VZ3z1dUo7zZWlDk8z4cK2lud0uQv7dE0u7yXyQpPjQ34gUeKkE7b1CakqE1eKiyw1qUoWw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <header>
    <div class="wrap row">
      <h1>🏛️ Miras & Emlak Vergisi Beyanname Oluşturucu</h1>
      <div class="spacer"></div>
      <button class="btn" id="btnIntikalPdf">İntikal Özeti PDF</button>
      <button class="btn" id="btnZipAll">Hepsini indir (.zip)</button>
    </div>
  </header>

  <main class="wrap grid g-2" style="padding-top:12px">
    <!-- Sol kolon: Girdi formları -->
    <section class="grid g-1" style="gap:12px">
      <div class="card">
        <h2>Parametreler <span class="badge">Excel › PARAMETRELER</span></h2>
        <div class="grid g-2">
          <div><label class="tiny muted">Ad</label><input id="decName" placeholder="Vefat Eden Ad"/></div>
          <div><label class="tiny muted">Soyad</label><input id="decSurname" placeholder="Vefat Eden Soyad"/></div>
          <div><label class="tiny muted">T.C. Kimlik No</label><input id="decTckn" placeholder="11 haneli"/></div>
          <div><label class="tiny muted">Ölüm Tarihi</label><input id="deathDate" type="date"/></div>
          <div><label class="tiny muted">Ölüm İli</label><input id="deathProvince" placeholder="İl"/></div>
          <div><label class="tiny muted">Ölüm İlçesi</label><input id="deathDistrict" placeholder="İlçe"/></div>
          <div class="g-1" style="grid-column:1/-1"><label class="tiny muted">Adres</label><textarea id="decAddress" placeholder="Son ikamet adresi"></textarea></div>
        </div>
      </div>

      <div class="card">
        <div class="row"><h2>Mükellef Bilgileri / Mirasçılar <span class="badge">Excel › MÜKELLEF BİLGİLERİ</span></h2><div class="spacer"></div><button class="btn" id="addHeir">+ Mirasçı Ekle</button></div>
        <div id="heirsList" class="grid" style="gap:10px"></div>
        <div class="row muted tiny" id="heirsTotal">Toplam Pay: 0%</div>
        <div class="tiny muted">Not: İleri durumlar için <b>Özel Pay %</b> girerseniz, paylar girilen yüzdelerden normalize edilir.</div>
      </div>

      <div class="card">
        <div class="row"><h2>Taşınmazlar <span class="badge">Excel › İNTİKAL & BİREYSEL_*</span></h2>
          <div class="spacer"></div>
          <div class="row">
            <button class="btn" data-add-prop="arazi">+ Arazi</button>
            <button class="btn" data-add-prop="arsa">+ Arsa</button>
            <button class="btn" data-add-prop="bina">+ Bina</button>
          </div>
        </div>
        <div id="propsList" class="grid" style="gap:10px"></div>
      </div>
    </section>

    <!-- Sağ kolon: PDF önizleme blokları -->
    <section class="grid g-1" style="gap:12px">
      <div class="card">
        <h2>İntikal Özeti (Önizleme) <span class="badge">Excel › İNTİKAL(Arazi-Arsa-Bina)</span></h2>
        <div id="pdf-intikal" class="pdf-sheet">
          <div class="center muted tiny">İNTİKAL ÖZET FORMU</div>
          <div class="divider"></div>
          <div class="grid g-2 tiny">
            <div><b>Vefat Eden:</b> <span id="vi-name"></span></div>
            <div><b>TCKN:</b> <span id="vi-tckn"></span></div>
            <div><b>Ölüm Tarihi:</b> <span id="vi-death"></span></div>
            <div><b>Yer:</b> <span id="vi-place"></span></div>
            <div style="grid-column:1/-1"><b>Adres:</b> <span id="vi-address"></span></div>
          </div>
          <div class="section-title">Mirasçılar ve Paylar</div>
          <table class="tiny" id="tbl-heirs-intikal">
            <thead><tr><th>Ad Soyad</th><th>Yakınlık</th><th class="center">Pay</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="right tiny muted" id="vi-total">Toplam: 0%</div>
          <div class="section-title">Taşınmaz Listesi</div>
          <table class="tiny" id="tbl-props-intikal">
            <thead><tr><th>Tür</th><th>İl/İlçe</th><th>Mahalle</th><th>Ada/Parsel</th><th class="right">m²</th><th class="center">Pay</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="row right" style="margin-top:8px"><div class="spacer"></div><button class="btn" id="btnIntikalPdf2">PDF indir</button></div>
      </div>

      <div class="card">
        <h2>Bireysel — Arazi <span class="badge">Excel › BİREYSEL_Arazi</span></h2>
        <div id="pdf-bireysel-arazi" class="pdf-sheet">
          <div class="center tiny muted">BİREYSEL ARAZİ — Emlak Vergisi Beyannamesi</div>
          <div id="arazi-sections" class="grid" style="gap:10px"></div>
        </div>
        <div class="row right" style="margin-top:8px"><div class="spacer"></div><button class="btn" id="btnAraziPdf">PDF indir</button></div>
      </div>

      <div class="card">
        <h2>Bireysel — Arsa <span class="badge">Excel › BİREYSEL_Arsa</span></h2>
        <div id="pdf-bireysel-arsa" class="pdf-sheet">
          <div class="center tiny muted">BİREYSEL ARSA — Emlak Vergisi Beyannamesi</div>
          <div id="arsa-sections" class="grid" style="gap:10px"></div>
        </div>
        <div class="row right" style="margin-top:8px"><div class="spacer"></div><button class="btn" id="btnArsaPdf">PDF indir</button></div>
      </div>

      <div class="card">
        <h2>Bireysel — Bina <span class="badge">Excel › BİREYSEL_Bina</span></h2>
        <div id="pdf-bireysel-bina" class="pdf-sheet">
          <div class="center tiny muted">BİREYSEL BİNA — Emlak Vergisi Beyannamesi</div>
          <div id="bina-sections" class="grid" style="gap:10px"></div>
        </div>
        <div class="row right" style="margin-top:8px"><div class="spacer"></div><button class="btn" id="btnBinaPdf">PDF indir</button></div>
      </div>

      <div class="card">
        <h2>Vergi Beyanname — Özet <span class="badge">Excel › VERG. BEYANNAME</span></h2>
        <div id="pdf-vergi-beyan" class="pdf-sheet">
          <div class="grid g-3 tiny">
            <div class="card" style="padding:8px"><div><b>Arazi</b></div><div id="count-arazi">Adet: 0</div></div>
            <div class="card" style="padding:8px"><div><b>Arsa</b></div><div id="count-arsa">Adet: 0</div></div>
            <div class="card" style="padding:8px"><div><b>Bina</b></div><div id="count-bina">Adet: 0</div></div>
          </div>
          <div class="section-title">Mükellef Bazlı Beyanlar</div>
          <table class="tiny" id="tbl-vergi-summary">
            <thead><tr><th>Mükellef</th><th class="center">Arazi</th><th class="center">Arsa</th><th class="center">Bina</th><th class="center">Toplam</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="row right" style="margin-top:8px"><div class="spacer"></div><button class="btn" id="btnVergiPdf">PDF indir</button></div>
      </div>
    </section>
  </main>

  <footer class="wrap tiny muted" style="padding-bottom:24px">
    Excel eşlemesi: PARAMETRELER → form; İNTİKAL → özet; MÜKELLEF BİLGİLERİ → mirasçılar; BİREYSEL_Arazi/Arsa/Bina → bireysel beyannameler; VERG. BEYANNAME → özet.
  </footer>

  <script>
  // ---------- Model ----------
  const RELATIONS = [
    { value: 'spouse', label: 'Eş' },
    { value: 'child', label: 'Çocuk' },
    { value: 'parent', label: 'Anne/Baba' },
    { value: 'sibling', label: 'Kardeş' },
    { value: 'grandparent', label: 'Dede/Nine' },
    { value: 'other', label: 'Diğer' }
  ];
  const PROPERTY_TYPES = [
    { value: 'arazi', label: 'Arazi' },
    { value: 'arsa', label: 'Arsa' },
    { value: 'bina', label: 'Bina' }
  ];

  const state = {
    params: {
      decedentName: '', decedentSurname: '', tckn: '', deathDate: '', deathProvince: '', deathDistrict: '', decedentAddress: ''
    },
    heirs: [], // {id,name,surname,tckn,relation,customShare}
    properties: [] // {id,type,province,district,neighborhood,block,parcel,area,address,acquisitionDate,reason,grossShare}
  };

  function uid(){ return 'id_'+Math.random().toString(36).slice(2,9); }
  function fmtPct(x){ return (Math.round(x*10000)/100).toFixed(2)+'%'; }

  // ---------- Inheritance Engine (TMK pratik) ----------
  function computeHeirShares(heirs){
    const total = 1.0;
    const spouse = heirs.filter(h=>h.relation==='spouse');
    const children = heirs.filter(h=>h.relation==='child');
    const parents = heirs.filter(h=>h.relation==='parent');
    const siblings = heirs.filter(h=>h.relation==='sibling');
    const grands = heirs.filter(h=>h.relation==='grandparent');

    const hasCustom = heirs.some(h=> h.customShare !== undefined && h.customShare !== null && h.customShare !== '' && !Number.isNaN(Number(h.customShare)) );
    if(hasCustom){
      const sum = heirs.reduce((acc,h)=> acc + (Number(h.customShare)||0), 0) || 1;
      const out = {}; heirs.forEach(h=> out[h.id] = (Number(h.customShare)||0) / sum );
      return out;
    }

    const sCount = spouse.length;
    const result = Object.fromEntries(heirs.map(h=>[h.id,0]));

    if(sCount>0 && children.length>0){
      const spouseShare = 0.25; const rest = total - spouseShare; const eachChild = rest / children.length;
      spouse.forEach(h=> result[h.id]+= spouseShare / sCount);
      children.forEach(h=> result[h.id]+= eachChild);
      return result;
    }
    if(sCount>0 && (parents.length>0 || siblings.length>0)){
      const spouseShare = 0.5; const zRest = total - spouseShare; // 0.5
      spouse.forEach(h=> result[h.id]+= spouseShare / sCount);
      if(parents.length===2){ parents.forEach(h=> result[h.id]+= 0.25); }
      else if(parents.length===1){ parents.forEach(h=> result[h.id]+= 0.25); const sibShare=0.25; const eachS = siblings.length? sibShare/siblings.length:0; siblings.forEach(h=> result[h.id]+= eachS); }
      else { const eachS = siblings.length? zRest/siblings.length:0; siblings.forEach(h=> result[h.id]+= eachS); }
      return result;
    }
    if(sCount>0 && grands.length>0){
      const spouseShare = 0.75; const rest = total - spouseShare; const eachG = rest / grands.length;
      spouse.forEach(h=> result[h.id]+= spouseShare / sCount); grands.forEach(h=> result[h.id]+= eachG); return result;
    }
    if(sCount>0 && children.length===0 && parents.length===0 && siblings.length===0 && grands.length===0){
      spouse.forEach(h=> result[h.id]+= total / sCount); return result;
    }

    // No spouse
    if(children.length>0){ const each = total/children.length; children.forEach(h=> result[h.id]+= each); return result; }
    if(parents.length>0 || siblings.length>0){
      if(parents.length>0){ const eachP = 0.5/parents.length; parents.forEach(h=> result[h.id]+= eachP); const sibShare=0.5; const eachS = siblings.length? sibShare/siblings.length:0; siblings.forEach(h=> result[h.id]+= eachS); }
      else { const eachS = siblings.length? total/siblings.length:0; siblings.forEach(h=> result[h.id]+= eachS); }
      return result;
    }
    if(grands.length>0){ const each = total/grands.length; grands.forEach(h=> result[h.id]+= each); return result; }
    return result; // aksi halde 0 (Hazine)
  }

  // ---------- DOM helpers ----------
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  function bindParams(){
    const map = [
      ['decName','decedentName'],['decSurname','decedentSurname'],['decTckn','tckn'],['deathDate','deathDate'],
      ['deathProvince','deathProvince'],['deathDistrict','deathDistrict'],['decAddress','decedentAddress']
    ];
    map.forEach(([id,key])=>{
      const el = document.getElementById(id); if(!el) return;
      el.addEventListener('input',()=>{ state.params[key] = el.value; render(); });
    })
  }

  function renderHeirs(){
    const wrap = $('#heirsList'); wrap.innerHTML = '';
    const shares = computeHeirShares(state.heirs);
    state.heirs.forEach(h=>{
      const row = document.createElement('div'); row.className = 'card'; row.style.padding='10px';
      row.innerHTML = `
        <div class="grid g-4">
          <div><label class="tiny muted">Ad</label><input data-heir="name" data-id="${h.id}" value="${h.name||''}" placeholder="Ad"/></div>
          <div><label class="tiny muted">Soyad</label><input data-heir="surname" data-id="${h.id}" value="${h.surname||''}" placeholder="Soyad"/></div>
          <div><label class="tiny muted">TCKN</label><input data-heir="tckn" data-id="${h.id}" value="${h.tckn||''}" placeholder="TCKN"/></div>
          <div>
            <label class="tiny muted">Yakınlık</label>
            <select data-heir="relation" data-id="${h.id}">
              ${RELATIONS.map(r=>`<option value="${r.value}" ${h.relation===r.value?'selected':''}>${r.label}</option>`).join('')}
            </select>
          </div>
          <div style="grid-column:1/-1" class="row tiny">
            <div class="pill">Hesaplanan pay: <b>${fmtPct(shares[h.id]||0)}</b></div>
            <div class="pill">Özel Pay %: <input data-heir="customShare" data-id="${h.id}" type="number" min="0" step="0.01" value="${h.customShare!==undefined && h.customShare!==null ? (Number(h.customShare)*100) : ''}" style="width:90px"/> </div>
            <div class="spacer"></div>
            <button class="btn danger" data-del-heir="${h.id}">Sil</button>
          </div>
        </div>`;
      wrap.appendChild(row);
    });

    wrap.querySelectorAll('input[data-heir], select[data-heir]').forEach(el=>{
      el.addEventListener('input', e=>{
        const inp = e.target; const key = inp.getAttribute('data-heir'); const id = inp.getAttribute('data-id');
        state.heirs = state.heirs.map(x=> x.id===id ? ({...x, [key]: key==='customShare' ? (inp.value===''? undefined : Number(inp.value)/100) : inp.value}) : x);
        render();
      })
    })
    wrap.querySelectorAll('button[data-del-heir]').forEach(btn=>{
      btn.addEventListener('click',()=>{ const id = btn.getAttribute('data-del-heir'); state.heirs = state.heirs.filter(x=>x.id!==id); render(); })
    })

    const total = Object.values(computeHeirShares(state.heirs)).reduce((a,b)=>a+b,0);
    $('#heirsTotal').textContent = `Toplam Pay: ${(Math.round(total*10000)/100).toFixed(2)}%`;
  }

  function renderProps(){
    const wrap = $('#propsList'); wrap.innerHTML = '';
    state.properties.forEach(p=>{
      const row = document.createElement('div'); row.className='card'; row.style.padding='10px';
      row.innerHTML = `
        <div class="row"><b>${PROPERTY_TYPES.find(t=>t.value===p.type)?.label||p.type}</b><div class="spacer"></div><button class="btn danger" data-del-prop="${p.id}">Sil</button></div>
        <div class="grid g-4">
          <div><label class="tiny muted">İl</label><input data-prop="province" data-id="${p.id}" value="${p.province||''}"/></div>
          <div><label class="tiny muted">İlçe</label><input data-prop="district" data-id="${p.id}" value="${p.district||''}"/></div>
          <div><label class="tiny muted">Mahalle/Köy</label><input data-prop="neighborhood" data-id="${p.id}" value="${p.neighborhood||''}"/></div>
          <div><label class="tiny muted">Ada</label><input data-prop="block" data-id="${p.id}" value="${p.block||''}"/></div>
          <div><label class="tiny muted">Parsel</label><input data-prop="parcel" data-id="${p.id}" value="${p.parcel||''}"/></div>
          <div><label class="tiny muted">Yüzölçümü (m²)</label><input type="number" step="0.01" data-prop="area" data-id="${p.id}" value="${p.area||0}"/></div>
          <div class="g-1" style="grid-column:1/-1"><label class="tiny muted">Adres</label><input data-prop="address" data-id="${p.id}" value="${p.address||''}"/></div>
          <div><label class="tiny muted">İntikal/Edinme Tarihi</label><input type="date" data-prop="acquisitionDate" data-id="${p.id}" value="${p.acquisitionDate||''}"/></div>
          <div><label class="tiny muted">Edinme Sebebi</label><input data-prop="reason" data-id="${p.id}" value="${p.reason||'Veraset (İntikal)'}"/></div>
          <div class="row tiny" style="grid-column:1/-1"><div class="pill">Taşınmaz toplam payı (1=tam): <input type="number" min="0.01" max="1" step="0.01" data-prop="grossShare" data-id="${p.id}" value="${p.grossShare ?? 1}" style="width:100px"/></div></div>
        </div>`;
      wrap.appendChild(row);
    })

    wrap.querySelectorAll('input[data-prop]').forEach(inp=>{
      inp.addEventListener('input', e=>{
        const el=e.target; const key=el.getAttribute('data-prop'); const id=el.getAttribute('data-id');
        state.properties = state.properties.map(x=> x.id===id ? ({...x, [key]: key==='area' || key==='grossShare' ? Number(el.value) : el.value}) : x);
        render();
      })
    })
    wrap.querySelectorAll('button[data-del-prop]').forEach(btn=>{
      btn.addEventListener('click',()=>{ const id=btn.getAttribute('data-del-prop'); state.properties = state.properties.filter(x=>x.id!==id); render(); })
    })
  }

  function updatePreview_Intikal(shares){
    // header fields
    $('#vi-name').textContent = `${state.params.decedentName||''} ${state.params.decedentSurname||''}`.trim();
    $('#vi-tckn').textContent = state.params.tckn||'';
    $('#vi-death').textContent = state.params.deathDate||'';
    $('#vi-place').textContent = `${state.params.deathProvince||''}/${state.params.deathDistrict||''}`;
    $('#vi-address').textContent = state.params.decedentAddress||'';

    // heirs table
    const tb = $('#tbl-heirs-intikal tbody'); tb.innerHTML='';
    state.heirs.forEach(h=>{
      const tr = document.createElement('tr');
      const rel = RELATIONS.find(r=>r.value===h.relation)?.label || h.relation;
      tr.innerHTML = `<td>${h.name||''} ${h.surname||''}</td><td>${rel}</td><td class="center">${fmtPct(shares[h.id]||0)}</td>`;
      tb.appendChild(tr);
    })
    const sum = Object.values(shares).reduce((a,b)=>a+b,0);
    $('#vi-total').textContent = `Toplam: ${(Math.round(sum*10000)/100).toFixed(2)}%`;

    // props table
    const pbody = $('#tbl-props-intikal tbody'); pbody.innerHTML='';
    state.properties.forEach(p=>{
      const tr = document.createElement('tr');
      const label = PROPERTY_TYPES.find(t=>t.value===p.type)?.label || p.type;
      tr.innerHTML = `<td>${label}</td><td>${p.province||''}/${p.district||''}</td><td>${p.neighborhood||''}</td><td>${p.block||''}/${p.parcel||''}</td><td class="right">${Number(p.area||0)}</td><td class="center">${fmtPct(p.grossShare ?? 1)}</td>`;
      pbody.appendChild(tr);
    })
  }

  function sectionForType(type, containerId, shares){
    const cont = document.getElementById(containerId); cont.innerHTML='';
    const props = state.properties.filter(p=>p.type===type);
    if(props.length===0){ cont.innerHTML = '<div class="tiny muted">Kayıt yok.</div>'; return; }
    state.heirs.forEach(h=>{
      const div = document.createElement('div'); div.className='card'; div.style.padding='8px';
      const hissePct = fmtPct(shares[h.id]||0);
      div.innerHTML = `<div class="tiny"><b>Mükellef:</b> ${h.name||''} ${h.surname||''} — <b>Hisse:</b> ${hissePct}</div>`;
      const tbl = document.createElement('table'); tbl.className='tiny';
      tbl.innerHTML = '<thead><tr><th>İl/İlçe</th><th>Mahalle</th><th>Ada/Parsel</th><th class="right">m²</th><th class="center">Pay</th></tr></thead>';
      const tb = document.createElement('tbody');
      props.forEach(p=>{
        const hisse = (shares[h.id]||0) * (p.grossShare ?? 1);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${p.province||''}/${p.district||''}</td><td>${p.neighborhood||''}</td><td>${p.block||''}/${p.parcel||''}</td><td class="right">${Number(p.area||0)}</td><td class="center">${fmtPct(hisse)}</td>`;
        tb.appendChild(tr);
      })
      tbl.appendChild(tb); div.appendChild(tbl); cont.appendChild(div);
    })
  }

  function updatePreview_Vergi(shares){
    const arazi = state.properties.filter(p=>p.type==='arazi');
    const arsa = state.properties.filter(p=>p.type==='arsa');
    const bina = state.properties.filter(p=>p.type==='bina');
    $('#count-arazi').textContent = 'Adet: '+arazi.length;
    $('#count-arsa').textContent = 'Adet: '+arsa.length;
    $('#count-bina').textContent = 'Adet: '+bina.length;

    const tb = $('#tbl-vergi-summary tbody'); tb.innerHTML='';
    state.heirs.forEach(h=>{
      const sa = arazi.reduce((acc,p)=> acc + (p.grossShare ?? 1)*(shares[h.id]||0), 0);
      const ss = arsa.reduce((acc,p)=> acc + (p.grossShare ?? 1)*(shares[h.id]||0), 0);
      const sb = bina.reduce((acc,p)=> acc + (p.grossShare ?? 1)*(shares[h.id]||0), 0);
      const total = sa+ss+sb;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${h.name||''} ${h.surname||''}</td><td class="center">${fmtPct(sa)}</td><td class="center">${fmtPct(ss)}</td><td class="center">${fmtPct(sb)}</td><td class="center"><b>${fmtPct(total)}</b></td>`;
      tb.appendChild(tr);
    })
  }

  function render(){
    renderHeirs();
    renderProps();
    const shares = computeHeirShares(state.heirs);
    updatePreview_Intikal(shares);
    sectionForType('arazi','arazi-sections',shares);
    sectionForType('arsa','arsa-sections',shares);
    sectionForType('bina','bina-sections',shares);
    updatePreview_Vergi(shares);
  }

  // ---------- PDF helpers ----------
  async function elementToPdf(el, filename){
    const { jsPDF } = window.jspdf;
    const a4w = 595.28, a4h = 841.89, scale=2;
    const canvas = await html2canvas(el, { scale });
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF({ unit:'pt', format:'a4', compress:true });
    const pageWidth = a4w, pageHeight=a4h;
    const imgWidth = pageWidth;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    let position = 0, heightLeft = imgHeight;
    pdf.addImage(imgData,'PNG',0,position,imgWidth,imgHeight);
    heightLeft -= pageHeight;
    while(heightLeft>0){ pdf.addPage(); position = heightLeft * -1; pdf.addImage(imgData,'PNG',0,position,imgWidth,imgHeight); heightLeft -= pageHeight; }
    pdf.save(filename);
  }

  async function zipPdfs(pairs, zipName){
    const { jsPDF } = window.jspdf;
    const zip = new JSZip();
    for(const {el,filename} of pairs){
      const a4w=595.28, a4h=841.89, scale=2;
      const canvas = await html2canvas(el,{scale});
      const imgData = canvas.toDataURL('image/png');
      const pdf = new jsPDF({ unit:'pt', format:'a4', compress:true });
      const pageWidth=a4w, pageHeight=a4h;
      const imgWidth=pageWidth; const imgHeight=(canvas.height*imgWidth)/canvas.width;
      let position=0, heightLeft=imgHeight;
      pdf.addImage(imgData,'PNG',0,position,imgWidth,imgHeight);
      heightLeft -= pageHeight;
      while(heightLeft>0){ pdf.addPage(); position = heightLeft*-1; pdf.addImage(imgData,'PNG',0,position,imgWidth,imgHeight); heightLeft -= pageHeight; }
      const blob = pdf.output('blob'); const arr = await blob.arrayBuffer();
      zip.file(filename, arr);
    }
    const content = await zip.generateAsync({type:'blob'});
    saveAs(content, zipName);
  }

  // ---------- Events ----------
  document.getElementById('addHeir').addEventListener('click',()=>{
    state.heirs.push({ id:uid(), name:'', surname:'', tckn:'', relation:'child' });
    render();
  });
  $$('#propsList [data-add-prop]'); // placeholder to avoid errors if queried early
  $$('[data-add-prop]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const type = btn.getAttribute('data-add-prop');
      state.properties.push({ id:uid(), type, province:'', district:'', neighborhood:'', block:'', parcel:'', area:0, address:'', acquisitionDate: state.params.deathDate||'', reason:'Veraset (İntikal)', grossShare:1 });
      render();
    })
  })

  // Header buttons (and duplicates under previews)
  function collectPairs(){
    const surname = (state.params.decedentSurname||'').trim();
    const parts = [];
    const intikal = document.getElementById('pdf-intikal'); if(intikal) parts.push({el:intikal, filename:`INTIKAL_OZET_${surname}.pdf`});
    const arazi = document.getElementById('pdf-bireysel-arazi'); if(arazi && state.properties.some(p=>p.type==='arazi')) parts.push({el:arazi, filename:`BIREYSEL_ARAZI_${surname}.pdf`});
    const arsa = document.getElementById('pdf-bireysel-arsa'); if(arsa && state.properties.some(p=>p.type==='arsa')) parts.push({el:arsa, filename:`BIREYSEL_ARSA_${surname}.pdf`});
    const bina = document.getElementById('pdf-bireysel-bina'); if(bina && state.properties.some(p=>p.type==='bina')) parts.push({el:bina, filename:`BIREYSEL_BINA_${surname}.pdf`});
    const vergi = document.getElementById('pdf-vergi-beyan'); if(vergi) parts.push({el:vergi, filename:`VERGI_BEYANNAME_OZET_${surname}.pdf`});
    return parts;
  }

  document.getElementById('btnIntikalPdf').addEventListener('click',()=> elementToPdf(document.getElementById('pdf-intikal'), `INTIKAL_OZET_${(state.params.decedentSurname||'')}.pdf`));
  document.getElementById('btnIntikalPdf2').addEventListener('click',()=> elementToPdf(document.getElementById('pdf-intikal'), `INTIKAL_OZET_${(state.params.decedentSurname||'')}.pdf`));
  document.getElementById('btnAraziPdf').addEventListener('click',()=> elementToPdf(document.getElementById('pdf-bireysel-arazi'), `BIREYSEL_ARAZI_${(state.params.decedentSurname||'')}.pdf`));
  document.getElementById('btnArsaPdf').addEventListener('click',()=> elementToPdf(document.getElementById('pdf-bireysel-arsa'), `BIREYSEL_ARSA_${(state.params.decedentSurname||'')}.pdf`));
  document.getElementById('btnBinaPdf').addEventListener('click',()=> elementToPdf(document.getElementById('pdf-bireysel-bina'), `BIREYSEL_BINA_${(state.params.decedentSurname||'')}.pdf`));
  document.getElementById('btnVergiPdf').addEventListener('click',()=> elementToPdf(document.getElementById('pdf-vergi-beyan'), `VERGI_BEYANNAME_OZET_${(state.params.decedentSurname||'')}.pdf`));
  document.getElementById('btnZipAll').addEventListener('click',()=> zipPdfs(collectPairs(), `BEYANNAME_PAKET_${(state.params.decedentSurname||'')}.zip`));

  // Params bindings
  bindParams();
  render();
  </script>
</body>
</html>
