<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Miras & Emlak Beyanname OluÅŸturucu (Tek Sayfa HTML)</title>
  <meta name="description" content="Miras parametreleri, mirasÃ§Ä± pay daÄŸÄ±lÄ±mÄ± (temsil dahil) ve Arazi/Arsa/Bina iÃ§in bireysel emlak beyannamesi + Ã¼cretlendirme PDF Ã¼reten tek sayfalÄ±k uygulama." />
  <style>
    :root{--bg:#ffffff;--fg:#0b1220;--muted:#6b7280;--line:#e5e7eb;--card:#f8fafc;--accent:#0ea5e9;--danger:#ef4444}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{position:sticky;top:0;background:rgba(255,255,255,.85);backdrop-filter:saturate(1.2) blur(8px);border-bottom:1px solid var(--line)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:20px}
    h2{margin:0 0 8px;font-size:16px}
    h3{margin:0 0 8px;font-size:15px}
    .grid{display:grid;gap:12px}
    .g-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .g-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    @media (max-width: 960px){.g-2,.g-3,.g-4{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    .row{display:flex;gap:8px;align-items:center}
    .spacer{flex:1}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;color:var(--fg)}
    input[type="date"]{padding:8px 10px}
    textarea{min-height:72px}
    button{cursor:pointer;border:1px solid var(--line);background:#fff;color:var(--fg);padding:10px 14px;border-radius:12px}
    .btn{display:inline-flex;align-items:center;gap:8px}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.ghost{background:transparent}
    .btn.danger{border-color:var(--danger);color:var(--danger)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border:1px solid var(--line);border-radius:999px;background:#fff}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--line);padding:6px 8px;text-align:left}
    thead th{background:#eef2f7}
    .right{text-align:right}
    .center{text-align:center}

    .pdf-sheet{background:#fff;border:1px solid var(--line);border-radius:12px;padding:18px}
    .section-title{font-weight:600;margin:8px 0}

    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef6ff;color:#0b5cab;border:1px solid #dbeafe;font-size:12px}
    .tiny{font-size:12px}

    .divider{height:1px;background:var(--line);margin:12px 0}

    .invalid{border-color:var(--danger)!important;outline-color:var(--danger)!important}
    .error{color:var(--danger);font-size:12px}
    .subcard{background:#fff;border:1px dashed var(--line);border-radius:10px;padding:10px}
  </style>
  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <header>
    <div class="wrap row">
      <h1>ğŸ›ï¸ Miras & Emlak Vergisi Beyanname OluÅŸturucu</h1>
      <div class="spacer"></div>
      <button class="btn" id="btnIntikalPdf">Ä°ntikal Ã–zeti PDF</button>
      <button class="btn" id="btnZipAll">Hepsini indir (.zip)</button>
    </div>
  </header>

  <main class="wrap grid g-2" style="padding-top:12px">
    <!-- Sol kolon: Girdi formlarÄ± -->
    <section class="grid g-1" style="gap:12px">
      <div class="card">
        <h2>Parametreler <span class="badge">Excel â€º PARAMETRELER</span></h2>
        <div class="grid g-2">
          <div><label class="tiny muted">Ad</label><input id="decName" placeholder="Vefat Eden Ad"/></div>
          <div><label class="tiny muted">Soyad</label><input id="decSurname" placeholder="Vefat Eden Soyad"/></div>
          <div><label class="tiny muted">T.C. Kimlik No</label><input id="decTckn" placeholder="11 haneli"/></div>
          <div><label class="tiny muted">Ã–lÃ¼m Tarihi</label><input id="deathDate" type="date"/></div>
          <div><label class="tiny muted">Ã–lÃ¼m Ä°li</label><input id="deathProvince" placeholder="Ä°l"/></div>
          <div><label class="tiny muted">Ã–lÃ¼m Ä°lÃ§esi</label><input id="deathDistrict" placeholder="Ä°lÃ§e"/></div>
          <div><label class="tiny muted">e-Posta Adresi</label><input id="decEmail" placeholder="ornek@eposta.com"/></div>
          <div><label class="tiny muted">Vefat Eden SayÄ±sÄ±</label><input id="decCount" type="number" min="1" step="1" value="1"/></div>
          <div class="g-1" style="grid-column:1/-1"><label class="tiny muted">Adres</label><textarea id="decAddress" placeholder="Son ikamet adresi"></textarea></div>
        </div>
        <div class="row tiny" id="tcknError" style="display:none"><span class="error">TCKN geÃ§ersiz.</span><div class="spacer"></div><span class="muted">Kurallar: 11 hane, 10. ve 11. haneye gÃ¶re kontrol.</span></div>
      </div>

      <div class="card">
        <div class="row"><h2>MÃ¼kellef Bilgileri / MirasÃ§Ä±lar <span class="badge">Excel â€º MÃœKELLEF BÄ°LGÄ°LERÄ°</span></h2><div class="spacer"></div><button class="btn" id="addHeir">+ MirasÃ§Ä± Ekle</button></div>
        <div id="heirsList" class="grid" style="gap:10px"></div>
        <div class="row muted tiny" id="heirsTotal">Toplam Pay: 0%</div>
        <div class="tiny muted">Not: Ä°leri durumlar iÃ§in <b>Ã–zel Pay %</b> girerseniz, paylar girilen yÃ¼zdelerden normalize edilir. Temsil (predeceased) durumlarÄ±nda <b>Altsoy Ekle</b> ile torun/yeÄŸen ekleyin.</div>
      </div>

      <div class="card">
        <div class="row"><h2>TaÅŸÄ±nmazlar <span class="badge">Excel â€º Ä°NTÄ°KAL & BÄ°REYSEL_*</span></h2>
          <div class="spacer"></div>
          <div class="row">
            <button class="btn" data-add-prop="arazi">+ Arazi</button>
            <button class="btn" data-add-prop="arsa">+ Arsa</button>
            <button class="btn" data-add-prop="bina">+ Bina</button>
          </div>
        </div>
        <div id="propsList" class="grid" style="gap:10px"></div>
      </div>

      <div class="card">
        <h2>Ãœcretlendirme <span class="badge">Excel â€º ÃœCRETLENDÄ°RME</span></h2>
        <div class="grid g-3">
          <div class="subcard">
            <div class="tiny muted">Vefat Eden Birim Ãœcret (â‚º)</div>
            <input id="feeDecedent" type="number" min="0" step="0.01" value="0"/>
            <div class="tiny">SayÄ±: <span id="cntDecedent" class="mono">1</span></div>
          </div>
          <div class="subcard">
            <div class="tiny muted">MÃ¼kellef Birim Ãœcret (â‚º)</div>
            <input id="feeMukellef" type="number" min="0" step="0.01" value="0"/>
            <div class="tiny">SayÄ±: <span id="cntMukellef" class="mono">0</span></div>
          </div>
          <div class="subcard">
            <div class="tiny muted">TaÅŸÄ±nmaz Birim Ãœcret (â‚º)</div>
            <input id="feeProperty" type="number" min="0" step="0.01" value="0"/>
            <div class="tiny">SayÄ±: <span id="cntProperty" class="mono">0</span></div>
          </div>
        </div>
        <div class="divider"></div>
        <div id="pdf-ucret" class="pdf-sheet">
          <div class="center tiny muted">ÃœCRET UNSURLARI</div>
          <table class="tiny" id="tbl-fees">
            <thead>
              <tr><th>Kalem</th><th class="center">Birim Ãœcret (â‚º)</th><th class="center">Adet</th><th class="right">Tutar (â‚º)</th></tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr><th colspan="3" class="right">Genel Toplam</th><th class="right" id="feeTotal">â‚º0,00</th></tr>
            </tfoot>
          </table>
        </div>
        <div class="row right" style="margin-top:8px"><div class="spacer"></div><button class="btn" id="btnUcretPdf">PDF indir</button></div>
      </div>
    </section>

    <!-- SaÄŸ kolon: PDF Ã¶nizleme bloklarÄ± -->
    <section class="grid g-1" style="gap:12px">
      <div class="card">
        <h2>Ä°ntikal Ã–zeti (Ã–nizleme) <span class="badge">Excel â€º Ä°NTÄ°KAL(Arazi-Arsa-Bina)</span></h2>
        <div id="pdf-intikal" class="pdf-sheet">
          <div class="center muted tiny">Ä°NTÄ°KAL Ã–ZET FORMU</div>
          <div class="divider"></div>
          <div class="grid g-2 tiny">
            <div><b>Vefat Eden:</b> <span id="vi-name"></span></div>
            <div><b>TCKN:</b> <span id="vi-tckn"></span></div>
            <div><b>Ã–lÃ¼m Tarihi:</b> <span id="vi-death"></span></div>
            <div><b>Yer:</b> <span id="vi-place"></span></div>
            <div style="grid-column:1/-1"><b>Adres:</b> <span id="vi-address"></span></div>
            <div style="grid-column:1/-1"><b>e-Posta:</b> <span id="vi-email"></span></div>
          </div>
          <div class="section-title">MirasÃ§Ä±lar ve Paylar</div>
          <table class="tiny" id="tbl-heirs-intikal">
            <thead><tr><th>Ad Soyad</th><th>YakÄ±nlÄ±k</th><th class="center">Pay</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="right tiny muted" id="vi-total">Toplam: 0%</div>
          <div class="section-title">TaÅŸÄ±nmaz Listesi</div>
          <table class="tiny" id="tbl-props-intikal">
            <thead><tr><th>TÃ¼r</th><th>Ä°l/Ä°lÃ§e</th><th>Mahalle</th><th>Ada/Parsel</th><th class="right">mÂ²</th><th class="center">Pay</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="row right" style="margin-top:8px"><div class="spacer"></div><button class="btn" id="btnIntikalPdf2">PDF indir</button></div>
      </div>

      <div class="card">
        <h2>Bireysel â€” Arazi <span class="badge">Excel â€º BÄ°REYSEL_Arazi</span></h2>
        <div id="pdf-bireysel-arazi" class="pdf-sheet">
          <div class="center tiny muted">BÄ°REYSEL ARAZÄ° â€” Emlak Vergisi Beyannamesi</div>
          <div id="arazi-sections" class="grid" style="gap:10px"></div>
        </div>
        <div class="row right" style="margin-top:8px"><div class="spacer"></div><button class="btn" id="btnAraziPdf">PDF indir</button></div>
      </div>

      <div class="card">
        <h2>Bireysel â€” Arsa <span class="badge">Excel â€º BÄ°REYSEL_Arsa</span></h2>
        <div id="pdf-bireysel-arsa" class="pdf-sheet">
          <div class="center tiny muted">BÄ°REYSEL ARSA â€” Emlak Vergisi Beyannamesi</div>
          <div id="arsa-sections" class="grid" style="gap:10px"></div>
        </div>
        <div class="row right" style="margin-top:8px"><div class="spacer"></div><button class="btn" id="btnArsaPdf">PDF indir</button></div>
      </div>

      <div class="card">
        <h2>Bireysel â€” Bina <span class="badge">Excel â€º BÄ°REYSEL_Bina</span></h2>
        <div id="pdf-bireysel-bina" class="pdf-sheet">
          <div class="center tiny muted">BÄ°REYSEL BÄ°NA â€” Emlak Vergisi Beyannamesi</div>
          <div id="bina-sections" class="grid" style="gap:10px"></div>
        </div>
        <div class="row right" style="margin-top:8px"><div class="spacer"></div><button class="btn" id="btnBinaPdf">PDF indir</button></div>
      </div>

      <div class="card">
        <h2>Vergi Beyanname â€” Ã–zet <span class="badge">Excel â€º VERG. BEYANNAME</span></h2>
        <div id="pdf-vergi-beyan" class="pdf-sheet">
          <div class="grid g-3 tiny">
            <div class="card" style="padding:8px"><div><b>Arazi</b></div><div id="count-arazi">Adet: 0</div></div>
            <div class="card" style="padding:8px"><div><b>Arsa</b></div><div id="count-arsa">Adet: 0</div></div>
            <div class="card" style="padding:8px"><div><b>Bina</b></div><div id="count-bina">Adet: 0</div></div>
          </div>
          <div class="section-title">MÃ¼kellef BazlÄ± Beyanlar</div>
          <table class="tiny" id="tbl-vergi-summary">
            <thead><tr><th>MÃ¼kellef</th><th class="center">Arazi</th><th class="center">Arsa</th><th class="center">Bina</th><th class="center">Toplam</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="row right" style="margin-top:8px"><div class="spacer"></div><button class="btn" id="btnVergiPdf">PDF indir</button></div>
      </div>
    </section>
  </main>

  <footer class="wrap tiny muted" style="padding-bottom:24px">
    Excel eÅŸlemesi: PARAMETRELER â†’ form; Ä°NTÄ°KAL â†’ Ã¶zet; MÃœKELLEF BÄ°LGÄ°LERÄ° â†’ mirasÃ§Ä±lar (temsil dahil); BÄ°REYSEL_Arazi/Arsa/Bina â†’ bireysel beyannameler; VERG. BEYANNAME â†’ Ã¶zet; ÃœCRETLENDÄ°RME â†’ Ã¼cret PDF.
  </footer>

  <script>
  // ---------- Model ----------
  const RELATIONS = [
    { value: 'spouse', label: 'EÅŸ' },
    { value: 'child', label: 'Ã‡ocuk' },
    { value: 'parent', label: 'Anne/Baba' },
    { value: 'sibling', label: 'KardeÅŸ' },
    { value: 'grandparent', label: 'Dede/Nine' },
    { value: 'other', label: 'DiÄŸer' }
  ];
  const PROPERTY_TYPES = [
    { value: 'arazi', label: 'Arazi' },
    { value: 'arsa', label: 'Arsa' },
    { value: 'bina', label: 'Bina' }
  ];

  const state = {
    params: {
      decedentName: '', decedentSurname: '', tckn: '', deathDate: '', deathProvince: '', deathDistrict: '', decedentAddress: '', decEmail:'', decCount:1
    },
    heirs: [], // {id,name,surname,tckn,relation,customShare,deceased:boolean,descendants:[{id,name,surname,tckn,relation:'grandchild'|'niece'}]}
    properties: [] // {id,type,province,district,neighborhood,block,parcel,area,address,acquisitionDate,reason,grossShare}
  };

  function uid(){ return 'id_'+Math.random().toString(36).slice(2,9); }
  function fmtPct(x){ return (Math.round(x*10000)/100).toFixed(2)+'%'; }
  function fmtTRY(x){ return new Intl.NumberFormat('tr-TR',{style:'currency',currency:'TRY'}).format(x||0); }

  // ---------- Validations ----------
  function isValidTCKN(t){
    if(!/^\d{11}$/.test(t)) return false;
    if(t[0]==='0') return false;
    const digits = t.split('').map(Number);
    const oddSum = digits[0]+digits[2]+digits[4]+digits[6]+digits[8];
    const evenSum = digits[1]+digits[3]+digits[5]+digits[7];
    const d10 = ((oddSum*7 - evenSum) % 10 + 10) % 10;
    const d11 = (digits.slice(0,10).reduce((a,b)=>a+b,0)) % 10;
    return d10===digits[9] && d11===digits[10];
  }
  function notFuture(dateStr){ if(!dateStr) return true; return new Date(dateStr) <= new Date(); }

  // ---------- Inheritance Engine with Representation ----------
  function getTaxpayers(){
    const tps = [];
    state.heirs.forEach(h=>{
      tps.push({...h});
      if(h.deceased && Array.isArray(h.descendants)){
        h.descendants.forEach(d=> tps.push({...d}));
      }
    });
    return tps;
  }

  function computeHeirShares(){
    const heirs = state.heirs;
    const spouse = heirs.filter(h=>h.relation==='spouse' && !h.deceased);
    const parents = heirs.filter(h=>h.relation==='parent' && !h.deceased);
    const siblingsAlive = heirs.filter(h=>h.relation==='sibling' && !h.deceased);
    const siblingsDeceased = heirs.filter(h=>h.relation==='sibling' && h.deceased);
    const childrenAlive = heirs.filter(h=>h.relation==='child' && !h.deceased);
    const childrenDeceased = heirs.filter(h=>h.relation==='child' && h.deceased);
    const grands = heirs.filter(h=>h.relation==='grandparent' && !h.deceased);

    // Manual override (normalize % on top-level heirs only)
    const hasCustom = heirs.some(h=> h.customShare !== undefined && h.customShare !== null && h.customShare !== '' && !Number.isNaN(Number(h.customShare)) );
    const out = {};

    if(hasCustom){
      const sum = heirs.reduce((acc,h)=> acc + (Number(h.customShare)||0), 0) || 1;
      heirs.forEach(h=> out[h.id] = (Number(h.customShare)||0) / sum );
      // descendants ignored in manual mode
      return out;
    }

    const taxpayers = getTaxpayers();
    taxpayers.forEach(p=> out[p.id]=0);

    // 1) Descendants present? (alive children or deceased children with descendants)
    const childLines = childrenAlive.length + childrenDeceased.filter(c=>Array.isArray(c.descendants) && c.descendants.length>0).length;
    const hasDesc = childLines>0;

    if(spouse.length>0 && hasDesc){
      const spouseShare = 0.25;
      const rest = 1 - spouseShare;
      const lineShare = childLines>0 ? rest/childLines : 0;
      // spouse equally among spouses (teorik tek kiÅŸi)
      spouse.forEach(s=> out[s.id] += spouseShare/spouse.length);
      // living children
      childrenAlive.forEach(c=> out[c.id] += lineShare);
      // deceased children â†’ their descendants equally
      childrenDeceased.forEach(c=>{
        const ds = (c.descendants||[]).filter(Boolean);
        if(ds.length>0){
          const each = lineShare/ds.length;
          ds.forEach(d=> out[d.id] = (out[d.id]||0) + each);
        }
      });
      return out;
    }

    if(!hasDesc){
      // 2) Second parentela (parents/siblings) with spouse or not
      if(spouse.length>0 && (parents.length>0 || (siblingsAlive.length + siblingsDeceased.length)>0)){
        const spouseShare = 0.5; const zRest = 1 - spouseShare; // 0.5
        spouse.forEach(s=> out[s.id] += spouseShare/spouse.length);
        // Parents portion
        if(parents.length===2){ parents.forEach(p=> out[p.id] += 0.25); }
        else if(parents.length===1){ out[parents[0].id] += 0.25; }
        // Siblings portion
        let sibPool = 0;
        if(parents.length===2){ sibPool = 0; }
        else if(parents.length===1){ sibPool = 0.25; }
        else { sibPool = zRest; }
        const sibLines = siblingsAlive.length + siblingsDeceased.filter(s=>Array.isArray(s.descendants) && s.descendants.length>0).length;
        if(sibPool>0 && sibLines>0){
          const line = sibPool/sibLines;
          siblingsAlive.forEach(s=> out[s.id] += line);
          siblingsDeceased.forEach(s=>{
            const ds = (s.descendants||[]).filter(Boolean);
            if(ds.length>0){ const each=line/ds.length; ds.forEach(d=> out[d.id]=(out[d.id]||0)+each); }
          })
        }
        return out;
      }
      // spouse absent
      if(spouse.length===0){
        // parents or siblings
        if(parents.length>0 || (siblingsAlive.length + siblingsDeceased.length)>0){
          if(parents.length>0){
            const parentShare = Math.min(1, 0.5); // 0.5 to parents if exist
            const eachP = parentShare/parents.length;
            parents.forEach(p=> out[p.id] += eachP);
            const sibPool = 1 - parentShare;
            const sibLines = siblingsAlive.length + siblingsDeceased.filter(s=>Array.isArray(s.descendants) && s.descendants.length>0).length;
            if(sibPool>0 && sibLines>0){
              const line = sibPool/sibLines;
              siblingsAlive.forEach(s=> out[s.id] += line);
              siblingsDeceased.forEach(s=>{
                const ds=(s.descendants||[]).filter(Boolean);
                if(ds.length>0){ const each=line/ds.length; ds.forEach(d=> out[d.id]=(out[d.id]||0)+each); }
              })
            }
            return out;
          } else {
            // only siblings
            const sibLines = siblingsAlive.length + siblingsDeceased.filter(s=>Array.isArray(s.descendants) && s.descendants.length>0).length;
            if(sibLines>0){ const line = 1/sibLines; siblingsAlive.forEach(s=> out[s.id]+=line); siblingsDeceased.forEach(s=>{ const ds=(s.descendants||[]); if(ds.length){ const each=line/ds.length; ds.forEach(d=> out[d.id]=(out[d.id]||0)+each); } }) }
            return out;
          }
        }
      }
    }

    // 3) Third parentela (grandparents) when spouse exists and no previous groups
    if(spouse.length>0 && grands.length>0){
      const spouseShare = 0.75; const rest = 1 - spouseShare; const eachG = rest / grands.length;
      spouse.forEach(s=> out[s.id] += spouseShare/spouse.length); grands.forEach(g=> out[g.id] += eachG);
      return out;
    }

    // 4) Only spouse
    if(spouse.length>0 && childrenAlive.length===0 && childrenDeceased.length===0 && parents.length===0 && siblingsAlive.length===0 && siblingsDeceased.length===0 && grands.length===0){
      spouse.forEach(s=> out[s.id] += 1/spouse.length); return out;
    }

    // 5) No spouse, descendants or others
    // children only
    if(childrenAlive.length>0 || childrenDeceased.length>0){
      const lines = childrenAlive.length + childrenDeceased.filter(c=>Array.isArray(c.descendants) && c.descendants.length>0).length;
      const line = lines? 1/lines : 0;
      childrenAlive.forEach(c=> out[c.id]+=line);
      childrenDeceased.forEach(c=>{ const ds=(c.descendants||[]); if(ds.length){ const each=line/ds.length; ds.forEach(d=> out[d.id]=(out[d.id]||0)+each); } });
      return out;
    }
    // parents or siblings
    if(parents.length>0 || siblingsAlive.length>0 || siblingsDeceased.length>0){
      if(parents.length>0){ const each = 0.5/parents.length; parents.forEach(p=> out[p.id]+=each); const sibPool=0.5; const sibLines=siblingsAlive.length + siblingsDeceased.filter(s=>Array.isArray(s.descendants)&&s.descendants.length>0).length; if(sibLines>0){ const line=sibPool/sibLines; siblingsAlive.forEach(s=> out[s.id]+=line); siblingsDeceased.forEach(s=>{ const ds=(s.descendants||[]); if(ds.length){ const each2=line/ds.length; ds.forEach(d=> out[d.id]=(out[d.id]||0)+each2); } }) } return out; }
      else { const sibLines=siblingsAlive.length + siblingsDeceased.filter(s=>Array.isArray(s.descendants)&&s.descendants.length>0).length; if(sibLines>0){ const line=1/sibLines; siblingsAlive.forEach(s=> out[s.id]+=line); siblingsDeceased.forEach(s=>{ const ds=(s.descendants||[]); if(ds.length){ const each=line/ds.length; ds.forEach(d=> out[d.id]=(out[d.id]||0)+each); } }) } return out; }
    }

    // 6) Grandparents only
    if(grands.length>0){ const each = 1/grands.length; grands.forEach(g=> out[g.id]+=each); return out; }

    return out; // aksi halde 0 (Hazine)
  }

  // ---------- DOM helpers ----------
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  function bindParams(){
    const map = [
      ['decName','decedentName'],['decSurname','decedentSurname'],['decTckn','tckn'],['deathDate','deathDate'],
      ['deathProvince','deathProvince'],['deathDistrict','deathDistrict'],['decAddress','decedentAddress'],['decEmail','decEmail'],['decCount','decCount']
    ];
    map.forEach(([id,key])=>{
      const el = document.getElementById(id); if(!el) return;
      const handler = ()=>{ state.params[key] = (id==='decCount'? Math.max(1, Number(el.value||1)) : el.value); render(); };
      el.addEventListener('input', handler); handler();
    })

    // TCKN + Tarih validasyonu gÃ¶rselleÅŸtirme
    const tckn = $('#decTckn');
    const tErr = $('#tcknError');
    const death = $('#deathDate');
    const valT = ()=>{ const v=tckn.value.trim(); const ok=isValidTCKN(v); tckn.classList.toggle('invalid', !ok && v!=='' ); tErr.style.display = (!ok && v!=='')? 'flex':'none'; };
    const valD = ()=>{ const ok=notFuture(death.value); death.classList.toggle('invalid', !ok); };
    tckn.addEventListener('input', valT); death.addEventListener('input', valD);
    valT(); valD();
  }

  function renderHeirs(){
    const wrap = $('#heirsList'); wrap.innerHTML = '';
    const shares = computeHeirShares();
    const taxpayers = getTaxpayers();

    state.heirs.forEach(h=>{
      const row = document.createElement('div'); row.className = 'card'; row.style.padding='10px';
      row.innerHTML = `
        <div class="grid g-4">
          <div><label class="tiny muted">Ad</label><input data-heir="name" data-id="${h.id}" value="${h.name||''}" placeholder="Ad"/></div>
          <div><label class="tiny muted">Soyad</label><input data-heir="surname" data-id="${h.id}" value="${h.surname||''}" placeholder="Soyad"/></div>
          <div><label class="tiny muted">TCKN</label><input data-heir="tckn" data-id="${h.id}" value="${h.tckn||''}" placeholder="TCKN"/></div>
          <div>
            <label class="tiny muted">YakÄ±nlÄ±k</label>
            <select data-heir="relation" data-id="${h.id}">
              ${RELATIONS.map(r=>`<option value="${r.value}" ${h.relation===r.value?'selected':''}>${r.label}</option>`).join('')}
            </select>
          </div>
          <div class="row tiny" style="grid-column:1/-1;gap:12px">
            <div class="pill">Hesaplanan pay: <b>${fmtPct((shares[h.id]||0))}</b></div>
            <div class="pill">Ã–zel Pay %: <input data-heir="customShare" data-id="${h.id}" type="number" min="0" step="0.01" value="${h.customShare!==undefined && h.customShare!==null ? (Number(h.customShare)*100) : ''}" style="width:90px"/> </div>
            ${(h.relation==='child'||h.relation==='sibling')?`<label class="pill"><input type="checkbox" data-heir="deceased" data-id="${h.id}" ${h.deceased? 'checked':''}/> Vefat etti (temsil)</label>`:''}
            ${(h.relation==='child'||h.relation==='sibling')?`<button class="btn" data-add-desc="${h.id}">Altsoy Ekle</button>`:''}
            <div class="spacer"></div>
            <button class="btn danger" data-del-heir="${h.id}">Sil</button>
          </div>
          ${(h.relation==='child'||h.relation==='sibling')?`<div class="subcard" style="grid-column:1/-1"><div class="tiny muted">Temsil AltsoylarÄ±</div><div data-desc-list="${h.id}" class="grid" style="gap:6px"></div></div>`:''}
        </div>`;
      wrap.appendChild(row);
      // render descendants
      if((h.relation==='child' || h.relation==='sibling') && Array.isArray(h.descendants)){
        const list = row.querySelector(`[data-desc-list="${h.id}"]`);
        h.descendants.forEach(d=>{
          const div=document.createElement('div'); div.className='row';
          div.innerHTML = `
            <input placeholder="Ad" data-desc="name" data-parent="${h.id}" data-id="${d.id}" value="${d.name||''}" style="flex:1"/>
            <input placeholder="Soyad" data-desc="surname" data-parent="${h.id}" data-id="${d.id}" value="${d.surname||''}" style="flex:1"/>
            <input placeholder="TCKN" data-desc="tckn" data-parent="${h.id}" data-id="${d.id}" value="${d.tckn||''}" style="flex:1"/>
            <span class="tiny pill">Rol: ${(h.relation==='child')? 'Torun (Temsil)':'YeÄŸen (Temsil)'} </span>
            <button class="btn danger" data-del-desc="${d.id}" data-parent="${h.id}">Sil</button>`;
          list.appendChild(div);
        })
      }
    });

    wrap.querySelectorAll('input[data-heir], select[data-heir]').forEach(el=>{
      el.addEventListener('input', e=>{
        const inp = e.target; const key = inp.getAttribute('data-heir'); const id = inp.getAttribute('data-id');
        state.heirs = state.heirs.map(x=> {
          if(x.id!==id) return x; let v = inp.value; if(key==='customShare') v = (inp.value===''? undefined : Number(inp.value)/100); if(key==='deceased') v = inp.checked; return ({...x, [key]: v});
        });
        render();
      })
    })
    wrap.querySelectorAll('button[data-del-heir]').forEach(btn=>{
      btn.addEventListener('click',()=>{ const id = btn.getAttribute('data-del-heir'); state.heirs = state.heirs.filter(x=>x.id!==id); render(); })
    })
    wrap.querySelectorAll('button[data-add-desc]').forEach(btn=>{
      btn.addEventListener('click',()=>{ const pid=btn.getAttribute('data-add-desc'); state.heirs = state.heirs.map(x=> x.id===pid ? ({...x, descendants:[...(x.descendants||[]), {id:uid(), name:'', surname:'', tckn:'', relation:(x.relation==='child'?'grandchild':'niece')} ]}) : x); render(); })
    })
    wrap.querySelectorAll('input[data-desc], button[data-del-desc]').forEach(el=>{
      if(el.tagName==='INPUT'){
        el.addEventListener('input', e=>{ const inp=e.target; const key=inp.getAttribute('data-desc'); const pid=inp.getAttribute('data-parent'); const id=inp.getAttribute('data-id'); state.heirs = state.heirs.map(x=> x.id===pid? ({...x, descendants:(x.descendants||[]).map(d=> d.id===id? ({...d,[key]:inp.value}) : d ) }): x ); render(); })
      } else {
        el.addEventListener('click',()=>{ const pid=el.getAttribute('data-parent'); const id=el.getAttribute('data-del-desc'); state.heirs = state.heirs.map(x=> x.id===pid? ({...x, descendants:(x.descendants||[]).filter(d=> d.id!==id)}):x); render(); })
      }
    })

    const total = Object.values(computeHeirShares()).reduce((a,b)=>a+b,0);
    $('#heirsTotal').textContent = `Toplam Pay: ${(Math.round(total*10000)/100).toFixed(2)}%`;
  }

  function renderProps(){
    const wrap = $('#propsList'); wrap.innerHTML = '';
    state.properties.forEach(p=>{
      const row = document.createElement('div'); row.className='card'; row.style.padding='10px';
      row.innerHTML = `
        <div class="row"><b>${PROPERTY_TYPES.find(t=>t.value===p.type)?.label||p.type}</b><div class="spacer"></div><button class="btn danger" data-del-prop="${p.id}">Sil</button></div>
        <div class="grid g-4">
          <div><label class="tiny muted">Ä°l</label><input data-prop="province" data-id="${p.id}" value="${p.province||''}"/></div>
          <div><label class="tiny muted">Ä°lÃ§e</label><input data-prop="district" data-id="${p.id}" value="${p.district||''}"/></div>
          <div><label class="tiny muted">Mahalle/KÃ¶y</label><input data-prop="neighborhood" data-id="${p.id}" value="${p.neighborhood||''}"/></div>
          <div><label class="tiny muted">Ada</label><input data-prop="block" data-id="${p.id}" value="${p.block||''}"/></div>
          <div><label class="tiny muted">Parsel</label><input data-prop="parcel" data-id="${p.id}" value="${p.parcel||''}"/></div>
          <div><label class="tiny muted">YÃ¼zÃ¶lÃ§Ã¼mÃ¼ (mÂ²)</label><input type="number" step="0.01" data-prop="area" data-id="${p.id}" value="${p.area||0}"/></div>
          <div class="g-1" style="grid-column:1/-1"><label class="tiny muted">Adres</label><input data-prop="address" data-id="${p.id}" value="${p.address||''}"/></div>
          <div><label class="tiny muted">Ä°ntikal/Edinme Tarihi</label><input type="date" data-prop="acquisitionDate" data-id="${p.id}" value="${p.acquisitionDate||''}"/></div>
          <div><label class="tiny muted">Edinme Sebebi</label><input data-prop="reason" data-id="${p.id}" value="${p.reason||'Veraset (Ä°ntikal)'}"/></div>
          <div class="row tiny" style="grid-column:1/-1"><div class="pill">TaÅŸÄ±nmaz toplam payÄ± (1=tam): <input type="number" min="0.01" max="1" step="0.01" data-prop="grossShare" data-id="${p.id}" value="${p.grossShare ?? 1}" style="width:100px"/></div></div>
        </div>`;
      wrap.appendChild(row);
    })

    wrap.querySelectorAll('input[data-prop]').forEach(inp=>{
      inp.addEventListener('input', e=>{
        const el=e.target; const key=el.getAttribute('data-prop'); const id=el.getAttribute('data-id');
        state.properties = state.properties.map(x=> x.id===id ? ({...x, [key]: key==='area' || key==='grossShare' ? Number(el.value) : el.value}) : x);
        render();
      })
    })
    wrap.querySelectorAll('button[data-del-prop]').forEach(btn=>{
      btn.addEventListener('click',()=>{ const id=btn.getAttribute('data-del-prop'); state.properties = state.properties.filter(x=>x.id!==id); render(); })
    })
  }

  function updatePreview_Intikal(shares){
    // header fields
    $('#vi-name').textContent = `${state.params.decedentName||''} ${state.params.decedentSurname||''}`.trim();
    $('#vi-tckn').textContent = state.params.tckn||'';
    $('#vi-death').textContent = state.params.deathDate||'';
    $('#vi-place').textContent = `${state.params.deathProvince||''}/${state.params.deathDistrict||''}`;
    $('#vi-address').textContent = state.params.decedentAddress||'';
    $('#vi-email').textContent = state.params.decEmail||'';

    // heirs (taxpayers) table
    const tb = $('#tbl-heirs-intikal tbody'); tb.innerHTML='';
    const taxpayers = getTaxpayers();
    taxpayers.forEach(p=>{
      const tr = document.createElement('tr');
      const relLabel = p.relation==='grandchild'? 'Torun (Temsil)': (p.relation==='niece'? 'YeÄŸen (Temsil)' : (RELATIONS.find(r=>r.value===p.relation)?.label||p.relation));
      tr.innerHTML = `<td>${p.name||''} ${p.surname||''}</td><td>${relLabel}</td><td class="center">${fmtPct(shares[p.id]||0)}</td>`;
      tb.appendChild(tr);
    })
    const sum = Object.values(shares).reduce((a,b)=>a+b,0);
    $('#vi-total').textContent = `Toplam: ${(Math.round(sum*10000)/100).toFixed(2)}%`;

    // props table
    const pbody = $('#tbl-props-intikal tbody'); pbody.innerHTML='';
    state.properties.forEach(p=>{
      const tr = document.createElement('tr');
      const label = PROPERTY_TYPES.find(t=>t.value===p.type)?.label || p.type;
      tr.innerHTML = `<td>${label}</td><td>${p.province||''}/${p.district||''}</td><td>${p.neighborhood||''}</td><td>${p.block||''}/${p.parcel||''}</td><td class="right">${Number(p.area||0)}</td><td class="center">${fmtPct(p.grossShare ?? 1)}</td>`;
      pbody.appendChild(tr);
    })
  }

  function sectionForType(type, containerId, shares){
    const cont = document.getElementById(containerId); cont.innerHTML='';
    const props = state.properties.filter(p=>p.type===type);
    if(props.length===0){ cont.innerHTML = '<div class="tiny muted">KayÄ±t yok.</div>'; return; }
    const taxpayers = getTaxpayers();
    taxpayers.forEach(h=>{
      const div = document.createElement('div'); div.className='card'; div.style.padding='8px';
      const hissePct = fmtPct(shares[h.id]||0);
      const relLabel = h.relation==='grandchild'? 'Torun (Temsil)': (h.relation==='niece'? 'YeÄŸen (Temsil)' : (RELATIONS.find(r=>r.value===h.relation)?.label||h.relation));
      div.innerHTML = `<div class="tiny"><b>MÃ¼kellef:</b> ${h.name||''} ${h.surname||''} â€” <b>YakÄ±nlÄ±k:</b> ${relLabel} â€” <b>Hisse:</b> ${hissePct}</div>`;
      const tbl = document.createElement('table'); tbl.className='tiny';
      tbl.innerHTML = '<thead><tr><th>Ä°l/Ä°lÃ§e</th><th>Mahalle</th><th>Ada/Parsel</th><th class="right">mÂ²</th><th class="center">Pay</th></tr></thead>';
      const tb = document.createElement('tbody');
      props.forEach(p=>{
        const hisse = (shares[h.id]||0) * (p.grossShare ?? 1);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${p.province||''}/${p.district||''}</td><td>${p.neighborhood||''}</td><td>${p.block||''}/${p.parcel||''}</td><td class="right">${Number(p.area||0)}</td><td class="center">${fmtPct(hisse)}</td>`;
        tb.appendChild(tr);
      })
      tbl.appendChild(tb); div.appendChild(tbl); cont.appendChild(div);
    })
  }

  function updatePreview_Vergi(shares){
    const arazi = state.properties.filter(p=>p.type==='arazi');
    const arsa = state.properties.filter(p=>p.type==='arsa');
    const bina = state.properties.filter(p=>p.type==='bina');
    document.getElementById('count-arazi').textContent = 'Adet: '+arazi.length;
    document.getElementById('count-arsa').textContent = 'Adet: '+arsa.length;
    document.getElementById('count-bina').textContent = 'Adet: '+bina.length;

    const tb = document.querySelector('#tbl-vergi-summary tbody'); tb.innerHTML='';
    const taxpayers = getTaxpayers();
    taxpayers.forEach(h=>{
      const sa = arazi.reduce((acc,p)=> acc + (p.grossShare ?? 1)*(shares[h.id]||0), 0);
      const ss = arsa.reduce((acc,p)=> acc + (p.grossShare ?? 1)*(shares[h.id]||0), 0);
      const sb = bina.reduce((acc,p)=> acc + (p.grossShare ?? 1)*(shares[h.id]||0), 0);
      const total = sa+ss+sb;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${h.name||''} ${h.surname||''}</td><td class="center">${fmtPct(sa)}</td><td class="center">${fmtPct(ss)}</td><td class="center">${fmtPct(sb)}</td><td class="center"><b>${fmtPct(total)}</b></td>`;
      tb.appendChild(tr);
    })
  }

  function updateFees(){
    const decCount = Number(state.params.decCount)||1;
    const mukellefCount = getTaxpayers().length;
    const propCount = state.properties.length;
    document.getElementById('cntDecedent').textContent = decCount;
    document.getElementById('cntMukellef').textContent = mukellefCount;
    document.getElementById('cntProperty').textContent = propCount;

    const feeDec = Number(document.getElementById('feeDecedent').value||0);
    const feeMuk = Number(document.getElementById('feeMukellef').value||0);
    const feeProp = Number(document.getElementById('feeProperty').value||0);

    const rows = [
      {name:'Vefat Eden', unit:feeDec, cnt:decCount},
      {name:'MÃ¼kellef', unit:feeMuk, cnt:mukellefCount},
      {name:'TaÅŸÄ±nmaz', unit:feeProp, cnt:propCount}
    ];
    const tb = document.querySelector('#tbl-fees tbody'); tb.innerHTML='';
    let total = 0;
    rows.forEach(r=>{
      const tutar = r.unit * r.cnt; total += tutar;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.name}</td><td class="center">${fmtTRY(r.unit)}</td><td class="center">${r.cnt}</td><td class="right">${fmtTRY(tutar)}</td>`;
      tb.appendChild(tr);
    });
    document.getElementById('feeTotal').textContent = fmtTRY(total);
  }

  function render(){
    renderHeirs();
    renderProps();
    const shares = computeHeirShares();
    updatePreview_Intikal(shares);
    sectionForType('arazi','arazi-sections',shares);
    sectionForType('arsa','arsa-sections',shares);
    sectionForType('bina','bina-sections',shares);
    updatePreview_Vergi(shares);
    updateFees();
  }

  // ---------- PDF helpers ----------
  async function elementToPdf(el, filename){
    const { jsPDF } = window.jspdf;
    const a4w = 595.28, a4h = 841.89, scale=2;
    const canvas = await html2canvas(el, { scale });
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF({ unit:'pt', format:'a4', compress:true });
    const pageWidth = a4w, pageHeight=a4h;
    const imgWidth = pageWidth;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    let position = 0, heightLeft = imgHeight;
    pdf.addImage(imgData,'PNG',0,position,imgWidth,imgHeight);
    heightLeft -= pageHeight;
    while(heightLeft>0){ pdf.addPage(); position = heightLeft * -1; pdf.addImage(imgData,'PNG',0,position,imgWidth,imgHeight); heightLeft -= pageHeight; }
    pdf.save(filename);
  }

  async function zipPdfs(pairs, zipName){
    const { jsPDF } = window.jspdf;
    const zip = new JSZip();
    for(const {el,filename} of pairs){
      const a4w=595.28, a4h=841.89, scale=2;
      const canvas = await html2canvas(el,{scale});
      const imgData = canvas.toDataURL('image/png');
      const pdf = new jsPDF({ unit:'pt', format:'a4', compress:true });
      const pageWidth=a4w, pageHeight=a4h;
      const imgWidth=pageWidth; const imgHeight=(canvas.height*imgWidth)/canvas.width;
      let position=0, heightLeft=imgHeight;
      pdf.addImage(imgData,'PNG',0,position,imgWidth,imgHeight);
      heightLeft -= pageHeight;
      while(heightLeft>0){ pdf.addPage(); position = heightLeft*-1; pdf.addImage(imgData,'PNG',0,position,imgWidth,imgHeight); heightLeft -= pageHeight; }
      const blob = pdf.output('blob'); const arr = await blob.arrayBuffer();
      zip.file(filename, arr);
    }
    const content = await zip.generateAsync({type:'blob'});
    saveAs(content, zipName);
  }

  // ---------- Events ----------
  document.getElementById('addHeir').addEventListener('click',()=>{
    state.heirs.push({ id:uid(), name:'', surname:'', tckn:'', relation:'child', deceased:false, descendants:[] });
    render();
  });
  Array.from(document.querySelectorAll('[data-add-prop]')).forEach(btn=>{
    btn.addEventListener('click',()=>{
      const type = btn.getAttribute('data-add-prop');
      state.properties.push({ id:uid(), type, province:'', district:'', neighborhood:'', block:'', parcel:'', area:0, address:'', acquisitionDate: state.params.deathDate||'', reason:'Veraset (Ä°ntikal)', grossShare:1 });
      render();
    })
  })

  // Header buttons (and duplicates under previews)
  function collectPairs(){
    const surname = (state.params.decedentSurname||'').trim();
    const parts = [];
    const intikal = document.getElementById('pdf-intikal'); if(intikal) parts.push({el:intikal, filename:`INTIKAL_OZET_${surname}.pdf`});
    const arazi = document.getElementById('pdf-bireysel-arazi'); if(arazi && state.properties.some(p=>p.type==='arazi')) parts.push({el:arazi, filename:`BIREYSEL_ARAZI_${surname}.pdf`});
    const arsa = document.getElementById('pdf-bireysel-arsa'); if(arsa && state.properties.some(p=>p.type==='arsa')) parts.push({el:arsa, filename:`BIREYSEL_ARSA_${surname}.pdf`});
    const bina = document.getElementById('pdf-bireysel-bina'); if(bina && state.properties.some(p=>p.type==='bina')) parts.push({el:bina, filename:`BIREYSEL_BINA_${surname}.pdf`});
    const vergi = document.getElementById('pdf-vergi-beyan'); if(vergi) parts.push({el:vergi, filename:`VERGI_BEYANNAME_OZET_${surname}.pdf`});
    const ucret = document.getElementById('pdf-ucret'); if(ucret) parts.push({el:ucret, filename:`UCRETLENDIRME_${surname}.pdf`});
    return parts;
  }

  document.getElementById('btnIntikalPdf').addEventListener('click',()=> elementToPdf(document.getElementById('pdf-intikal'), `INTIKAL_OZET_${(state.params.decedentSurname||'')}.pdf`));
  document.getElementById('btnIntikalPdf2').addEventListener('click',()=> elementToPdf(document.getElementById('pdf-intikal'), `INTIKAL_OZET_${(state.params.decedentSurname||'')}.pdf`));
  document.getElementById('btnAraziPdf').addEventListener('click',()=> elementToPdf(document.getElementById('pdf-bireysel-arazi'), `BIREYSEL_ARAZI_${(state.params.decedentSurname||'')}.pdf`));
  document.getElementById('btnArsaPdf').addEventListener('click',()=> elementToPdf(document.getElementById('pdf-bireysel-arsa'), `BIREYSEL_ARSA_${(state.params.decedentSurname||'')}.pdf`));
  document.getElementById('btnBinaPdf').addEventListener('click',()=> elementToPdf(document.getElementById('pdf-bireysel-bina'), `BIREYSEL_BINA_${(state.params.decedentSurname||'')}.pdf`));
  document.getElementById('btnVergiPdf').addEventListener('click',()=> elementToPdf(document.getElementById('pdf-vergi-beyan'), `VERGI_BEYANNAME_OZET_${(state.params.decedentSurname||'')}.pdf`));
  document.getElementById('btnUcretPdf').addEventListener('click',()=> elementToPdf(document.getElementById('pdf-ucret'), `UCRETLENDIRME_${(state.params.decedentSurname||'')}.pdf`));
  document.getElementById('btnZipAll').addEventListener('click',()=> zipPdfs(collectPairs(), `BEYANNAME_PAKET_${(state.params.decedentSurname||'')}.zip`));

  // Params bindings
  bindParams();
  render();
  </script>
</body>
</html>
