<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Whiteboard ‚Äî Draw ‚Ä¢ Sticky Notes ‚Ä¢ Import/Export</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<style>
  :root{ --bg:#0b0f14; --panel:#111a25; --panel2:#0e1722; --text:#eaf0f7; --muted:#92a4bf; --border:#263446; --accent:#75c6ff; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0b0f14,#0f1520);color:var(--text);font:15px/1.5 system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
  header{max-width:1200px;margin:18px auto 0;padding:0 16px}
  h1{margin:0 0 6px;font-weight:800;font-size:24px}
  .sub{margin:0 0 14px;color:var(--muted)}
  main{max-width:1200px;margin:0 auto 18px;padding:0 16px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0 12px; position:relative; z-index:5}
  button,label.btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#132033;color:var(--text);cursor:pointer;transition:.15s transform ease;display:inline-flex;gap:8px;align-items:center}
  button:hover,label.btn:hover{transform:translateY(-1px)}
  .primary{background:linear-gradient(180deg,#24466d,#1b3553);border-color:#33537b}
  .ghost{background:transparent}
  .warn{background:linear-gradient(180deg,#5c3d16,#3f2a0e);border-color:#6a4b22}
  .seg{display:inline-flex;border:1px solid var(--border);border-radius:10px;overflow:hidden}
  .seg button{border:0;border-right:1px solid var(--border);background:#0f1827}
  .seg button.active{background:linear-gradient(180deg,#24466d,#1b3553)}
  .seg button:last-child{border-right:0}
  input[type="file"]{display:none}
  .tiny{font-size:12px;color:var(--muted)}
  .boardWrap{background:#0a1420;border:1px solid var(--border);border-radius:14px;box-shadow:0 10px 22px rgba(0,0,0,.35);position:relative;overflow:hidden}
  canvas{display:block;width:100%;height:70vh;background:#0b1625;cursor:crosshair; position:relative; z-index:1}
  .status{position:absolute;bottom:8px;right:12px;background:rgba(0,0,0,.45);border:1px solid #20344f;color:#cfe0ff;padding:5px 8px;border-radius:8px;font-size:12px; z-index:2}
  .floatingInput{position:absolute;min-width:180px;padding:4px 6px;border-radius:8px;border:1px solid var(--border);background:#0f1722;color:#eaf0f7; z-index:3}
</style>
</head>
<body>
<header>
  <h1>Whiteboard</h1>
  <p class="sub">Brush, highlighter, eraser, line, rectangle, text, <b>sticky notes</b>, pan/zoom. Import/Export PNG ‚Ä¢ SVG ‚Ä¢ JSON. Everything stays in your browser.</p>
</header>

<main>
  <div class="toolbar">
    <span class="tiny">Tools:</span>
    <span class="seg" id="toolSeg">
      <button type="button" data-tool="brush" class="active">‚úèÔ∏è Brush (B)</button>
      <button type="button" data-tool="highlighter">üñç Highlighter (H)</button>
      <button type="button" data-tool="eraser">üßΩ Eraser (E)</button>
      <button type="button" data-tool="line">Ôºè Line (L)</button>
      <button type="button" data-tool="rect">‚ñ≠ Rect (R)</button>
      <button type="button" data-tool="text">üî§ Text (T)</button>
      <button type="button" data-tool="sticky">üóí Sticky (S)</button>
      <button type="button" data-tool="select">üñ± Select (V)</button>
      <button type="button" data-tool="pan">‚úã Pan (Space)</button>
    </span>
    <span class="tiny">Color</span>
    <input type="color" id="color" value="#ffde59" />
    <span class="tiny">Size</span>
    <input type="range" id="size" min="1" max="48" value="6" />
    <span class="tiny">Opacity</span>
    <input type="range" id="opacity" min="0.05" max="1" step="0.05" value="1" />
    <span class="tiny">Zoom</span>
    <input type="range" id="zoom" min="0.5" max="3" step="0.05" value="1" />
    <button id="resetView" type="button">Reset view</button>
    <span class="tiny">BG</span>
    <select id="bg">
      <option value="grid" selected>Grid</option>
      <option value="dots">Dots</option>
      <option value="plain">Plain</option>
      <option value="lined">Lined</option>
    </select>
  </div>

  <div class="toolbar">
    <button id="undoBtn" type="button">Undo (Ctrl/Cmd+Z)</button>
    <button id="redoBtn" type="button">Redo (Ctrl/Cmd+Y)</button>
    <span class="tiny">|</span>
    <button id="exportPNG" type="button" class="primary">Export PNG</button>
    <button id="exportSVG" type="button">Export SVG</button>
    <button id="exportJSON" type="button">Export JSON</button>
    <label for="importJSON" class="btn">Import JSON<input id="importJSON" type="file" accept="application/json"></label>
    <span class="tiny">|</span>
    <label for="importIMG" class="btn">Insert Image<input id="importIMG" type="file" accept="image/*"></label>
    <button id="clearBoard" type="button" class="warn">Clear</button>
    <span class="tiny" id="saveState">Saved</span>
  </div>

  <div class="boardWrap">
    <canvas id="c"></canvas>
    <div class="status" id="status">loading‚Ä¶</div>
  </div>
</main>

<script>
// Show script errors in the status badge so you can see what's wrong
window.addEventListener('error', function(e){ var s=document.getElementById('status'); if(s) s.textContent='Error: '+e.message; });

(function(){
  function boot(){
    // ===== Utilities =====
    function $(sel){ return document.querySelector(sel); }
    function uid(p){ return p + '_' + Math.random().toString(36).slice(2,9); }
    function escapeXml(s){ return s.replace(/[&<>\"]/g, function(c){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c]); }); }

    // ===== Canvas & Viewport =====
    var canvas = $('#c');
    var ctx = canvas.getContext('2d');
    var view = { x:0, y:0, scale:1 };
    function resize(){ var rect = canvas.parentElement.getBoundingClientRect(); canvas.width=Math.max(800,rect.width); canvas.height=Math.max(500,rect.height); draw(); }
    window.addEventListener('resize', resize);
    function worldToScreen(x,y){ return { x:(x - view.x)*view.scale, y:(y - view.y)*view.scale }; }
    function screenToWorld(x,y){ return { x: x/view.scale + view.x, y: y/view.scale + view.y }; }

    // ===== State =====
    var LS_KEY='whiteboard_state_boot';
    var board = loadState() || { bg:'grid', elements:[] };
    var history = { past:[], future:[] };
    function save(){ localStorage.setItem(LS_KEY, JSON.stringify(board)); var s=$('#saveState'); if(s) s.textContent='Saved'; }
    function loadState(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||''); }catch(e){ return null; } }
    function pushHistory(){ history.past.push(JSON.stringify(board)); history.future.length=0; save(); }
    function undo(){ if(!history.past.length)return; history.future.push(JSON.stringify(board)); board=JSON.parse(history.past.pop()); save(); draw(); }
    function redo(){ if(!history.future.length)return; history.past.push(JSON.stringify(board)); board=JSON.parse(history.future.pop()); save(); draw(); }

    // ===== Tools =====
    var tool='brush'; var color=$('#color').value; var size=+$('#size').value; var opacity=+$('#opacity').value;
    var drawing=false; var current=null; var panActive=false; var panStart={x:0,y:0,vx:0,vy:0};
    var selection=null; // for sticky move

    function setTool(t){ tool=t; var btns=document.querySelectorAll('#toolSeg button'); for(var i=0;i<btns.length;i++){ btns[i].classList.toggle('active', btns[i].getAttribute('data-tool')===t); } updateStatus(); }
    document.getElementById('toolSeg').addEventListener('click', function(e){ var b=e.target.closest && e.target.closest('button[data-tool]'); if(!b) return; setTool(b.getAttribute('data-tool')); });

    // ===== Draw Helpers =====
    function drawGrid(){
      var spacing=50, s=view.scale, w=canvas.width, h=canvas.height; ctx.save(); ctx.clearRect(0,0,w,h); ctx.fillStyle='#0b1625'; ctx.fillRect(0,0,w,h);
      var startX=Math.floor(view.x/spacing)*spacing, endX=Math.ceil((view.x+w/s)/spacing)*spacing;
      var startY=Math.floor(view.y/spacing)*spacing, endY=Math.ceil((view.y+h/s)/spacing)*spacing;
      if(board.bg==='grid'||board.bg==='lined'||board.bg==='dots'){
        ctx.strokeStyle='rgba(255,255,255,0.07)'; ctx.lineWidth=1; ctx.beginPath();
        if(board.bg!=='lined'){
          for(var x=startX;x<=endX;x+=spacing){ var p1=worldToScreen(x,startY), p2=worldToScreen(x,endY); ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y);} }
        for(var y=startY;y<=endY;y+=spacing){ var p3=worldToScreen(startX,y), p4=worldToScreen(endX,y); ctx.moveTo(p3.x,p3.y); ctx.lineTo(p4.x,p4.y);} ctx.stroke();
        if(board.bg==='dots'){ ctx.fillStyle='rgba(255,255,255,0.18)'; for(var xx=startX; xx<=endX; xx+=spacing){ for(var yy=startY; yy<=endY; yy+=spacing){ var p=worldToScreen(xx,yy); ctx.fillRect(p.x-0.75,p.y-0.75,1.5,1.5);} } }
      }
      ctx.restore();
    }

    function renderElement(el){
      if(el.type==='stroke'||el.type==='highlight'||el.type==='eraser'){
        ctx.save(); ctx.globalAlpha = (el.type==='highlight') ? (el.opacity||0.35) : (el.opacity||1);
        if(el.type==='eraser') ctx.globalCompositeOperation='destination-out';
        ctx.lineCap='round'; ctx.lineJoin='round'; ctx.lineWidth=el.size*view.scale; ctx.strokeStyle=el.color||'#fff';
        ctx.beginPath(); for(var i=0;i<el.points.length;i++){ var p=worldToScreen(el.points[i].x, el.points[i].y); if(i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y);} ctx.stroke(); ctx.restore();
      }
      if(el.type==='line'||el.type==='rect'){
        ctx.save(); ctx.globalAlpha=el.opacity||1; ctx.lineWidth=el.size*view.scale; ctx.strokeStyle=el.color||'#fff';
        var p1=worldToScreen(el.x1,el.y1), p2=worldToScreen(el.x2,el.y2);
        if(el.type==='line'){ ctx.beginPath(); ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y); ctx.stroke(); }
        else{ var x=Math.min(p1.x,p2.x), y=Math.min(p1.y,p2.y), w=Math.abs(p2.x-p1.x), h=Math.abs(p2.y-p1.y); if(el.fill){ ctx.fillStyle=el.fill; ctx.globalAlpha=0.18; ctx.fillRect(x,y,w,h); ctx.globalAlpha=el.opacity||1; } ctx.strokeRect(x,y,w,h); }
        ctx.restore();
      }
      if(el.type==='text'){
        ctx.save(); ctx.globalAlpha=el.opacity||1; ctx.fillStyle=el.color||'#fff'; var tp=worldToScreen(el.x,el.y); ctx.font=(el.size||22) + 'px Inter, system-ui, sans-serif'; ctx.textBaseline='top';
        var lines=(el.text||'').split(/
/); for(var j=0;j<lines.length;j++){ ctx.fillText(lines[j], tp.x, tp.y + j*((el.size||22)*1.3)); } ctx.restore();
      }
      if(el.type==='image'){
        var ip=worldToScreen(el.x,el.y), is=worldToScreen(el.x+el.w, el.y+el.h); var iw=is.x-ip.x, ih=is.y-ip.y; var img=ensureImage(el); if(img) ctx.drawImage(img,ip.x,ip.y,iw,ih);
      }
      if(el.type==='sticky'){
        var sp=worldToScreen(el.x,el.y); var sw=el.w*view.scale, sh=el.h*view.scale; ctx.save();
        ctx.shadowColor='rgba(0,0,0,0.35)'; ctx.shadowBlur=8; ctx.shadowOffsetY=4; ctx.fillStyle=el.color||'#fff7a9'; ctx.strokeStyle='rgba(0,0,0,0.08)';
        ctx.translate(sp.x + sw/2, sp.y + sh/2); ctx.rotate(((el.rot||0)*Math.PI)/180); ctx.translate(-sw/2, -sh/2);
        ctx.fillRect(0,0,sw,sh); ctx.strokeRect(0,0,sw,sh);
        ctx.shadowColor='transparent'; ctx.fillStyle='#111'; ctx.globalAlpha=1; ctx.font='16px Inter, system-ui'; ctx.textBaseline='top';
        var pad=10; var words=(el.text||'').split(/
/); var yy=pad; for(var k=0;k<words.length;k++){ wrapText(ctx, words[k], pad, yy, sw-pad*2, 20); yy += 20 * Math.max(1, Math.ceil(ctx.measureText(words[k]).width/(sw-pad*2))); }
        ctx.restore();
      }
    }

    function wrapText(ctx, text, x, y, maxWidth, lineHeight){
      var words=text.split(' '); var line=''; for(var n=0;n<words.length;n++){ var test=line+words[n]+' '; var metrics=ctx.measureText(test); if(metrics.width>maxWidth && n>0){ ctx.fillText(line, x, y); line=words[n]+' '; y+=lineHeight; } else { line=test; } } ctx.fillText(line, x, y);
    }

    var imageCache=new Map();
    function ensureImage(el){ if(!el.dataURL) return null; if(imageCache.has(el.id)) return imageCache.get(el.id); var img=new Image(); img.onload=function(){ draw(); }; img.src=el.dataURL; imageCache.set(el.id,img); return img; }

    function draw(){ drawGrid(); for(var i=0;i<board.elements.length;i++){ renderElement(board.elements[i]); } if(selection){ var p=worldToScreen(selection.x,selection.y); ctx.save(); ctx.setLineDash([6,4]); ctx.strokeStyle='#75c6ff'; ctx.lineWidth=1; ctx.strokeRect(p.x, p.y, selection.w*view.scale, selection.h*view.scale); ctx.restore(); } updateStatus(); }

    // ===== Pointer Handling =====
    var spaceDown=false; // pan modifier
    canvas.addEventListener('pointerdown', function(e){
      e.preventDefault(); canvas.setPointerCapture(e.pointerId); var pt=screenToWorld(e.offsetX,e.offsetY);
      if(tool==='pan' || spaceDown){ panActive=true; panStart={x:e.clientX,y:e.clientY,vx:view.x,vy:view.y}; return; }

      if(tool==='select'){
        var hit = hitSticky(pt.x, pt.y); if(hit){ selection={ x:hit.x,y:hit.y,w:hit.w,h:hit.h,id:hit.id }; drawing=true; current={type:'drag', id:hit.id, offX:pt.x-hit.x, offY:pt.y-hit.y}; return; }
        selection=null; draw(); return;
      }

      if(tool==='brush' || tool==='highlighter' || tool==='eraser'){
        var baseOpacity = tool==='highlighter' ? Math.min(opacity,0.35) : opacity; current={ id:uid('st'), type: (tool==='brush'?'stroke':tool), points:[pt], color:color, size:size, opacity: baseOpacity }; board.elements.push(current); drawing=true; pushHistory(); draw(); return; }

      if(tool==='line' || tool==='rect'){
        current={ id:uid(tool), type:tool, x1:pt.x, y1:pt.y, x2:pt.x, y2:pt.y, color:color, size:size, opacity:opacity, fill: (tool==='rect'? color : null) }; drawing=true; pushHistory(); draw(); return; }

      if(tool==='text'){
        spawnTextInput(e.offsetX, e.offsetY, '', function(txt){ if(!txt) return; var wpt=screenToWorld(e.offsetX,e.offsetY); board.elements.push({ id:uid('txt'), type:'text', x:wpt.x, y:wpt.y, text:txt, color:color, size: Math.max(16, size*3/2), opacity:opacity }); pushHistory(); draw(); }); return; }

      if(tool==='sticky'){
        var w=220, h=160; var el={ id:uid('stk'), type:'sticky', x:pt.x- w/2, y:pt.y- h/2, w:w, h:h, color: color, text:'', rot:(Math.random()*2-1)*3 };
        board.elements.push(el); pushHistory(); draw();
        spawnTextInput(e.offsetX - w*view.scale/2 + 10, e.offsetY - h*view.scale/2 + 10, '', function(txt){ el.text = txt||''; save(); draw(); }); return; }
    });

    canvas.addEventListener('pointermove', function(e){
      var pt=screenToWorld(e.offsetX,e.offsetY);
      if(panActive){ var dx=(e.clientX-panStart.x)/view.scale, dy=(e.clientY-panStart.y)/view.scale; view.x=panStart.vx - dx; view.y=panStart.vy - dy; draw(); return; }
      if(!drawing) return;
      if(current && current.type==='drag'){
        var el = findById(current.id); if(!el) return; el.x = pt.x - current.offX; el.y = pt.y - current.offY; selection={x:el.x,y:el.y,w:el.w,h:el.h,id:el.id}; draw(); return; }
      if(current && (current.type==='stroke'||current.type==='highlight'||current.type==='eraser')){
        var last=current.points[current.points.length-1]; var dist=Math.hypot(pt.x-last.x, pt.y-last.y); if(dist>0.8) current.points.push(pt); draw(); return; }
      if(current && (current.type==='line'||current.type==='rect')){ current.x2=pt.x; current.y2=pt.y; draw(); return; }
    });

    window.addEventListener('pointerup', function(){ drawing=false; current=null; panActive=false; save(); });
    canvas.addEventListener('pointerleave', function(){ drawing=false; current=null; panActive=false; });

    // Space to pan
    window.addEventListener('keydown', function(e){ if(e.code==='Space'){ spaceDown=true; updateStatus(); }});
    window.addEventListener('keyup', function(e){ if(e.code==='Space'){ spaceDown=false; updateStatus(); }});

    function findById(id){ for(var i=board.elements.length-1;i>=0;i--){ if(board.elements[i].id===id) return board.elements[i]; } return null; }
    function hitSticky(x,y){ for(var i=board.elements.length-1;i>=0;i--){ var el=board.elements[i]; if(el.type!=='sticky') continue; if(x>=el.x && x<=el.x+el.w && y>=el.y && y<=el.y+el.h){ return {x:el.x,y:el.y,w:el.w,h:el.h,id:el.id}; } } return null; }

    // Floating text input
    function spawnTextInput(sx,sy,initial,onDone){ var input=document.createElement('textarea'); input.className='floatingInput'; input.style.left=sx+'px'; input.style.top=sy+'px'; input.value=initial||''; canvas.parentElement.appendChild(input); input.focus(); var finished=false; function finish(ok){ if(finished) return; finished=true; var val=input.value; input.remove(); if(ok) onDone(val); }
      input.addEventListener('keydown', function(e){ if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){ e.preventDefault(); finish(true);} if(e.key==='Escape'){ e.preventDefault(); finish(false);} }); input.addEventListener('blur', function(){ finish(true); }); }

    // UI Wiring
    document.getElementById('color').addEventListener('input', function(e){ color=e.target.value; updateStatus(); });
    document.getElementById('size').addEventListener('input', function(e){ size=+e.target.value; updateStatus(); });
    document.getElementById('opacity').addEventListener('input', function(e){ opacity=+e.target.value; updateStatus(); });
    document.getElementById('zoom').addEventListener('input', function(e){ view.scale=+e.target.value; draw(); });
    document.getElementById('resetView').addEventListener('click', function(){ view.x=0; view.y=0; view.scale=1; document.getElementById('zoom').value='1'; draw(); });
    document.getElementById('bg').addEventListener('change', function(e){ board.bg=e.target.value; draw(); save(); });
    document.getElementById('clearBoard').addEventListener('click', function(){ if(confirm('Clear the whiteboard?')){ board.elements=[]; pushHistory(); draw(); } });
    document.getElementById('undoBtn').addEventListener('click', undo); document.getElementById('redoBtn').addEventListener('click', redo);

    // keyboard shortcuts
    window.addEventListener('keydown', function(e){ if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='z'){ e.preventDefault(); undo(); return;} if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='y'){ e.preventDefault(); redo(); return;} var map={b:'brush', h:'highlighter', e:'eraser', l:'line', r:'rect', t:'text', s:'sticky', v:'select'}; if(map[e.key]) setTool(map[e.key]); });

    // Insert Image
    document.getElementById('importIMG').addEventListener('change', function(){ var input=document.getElementById('importIMG'); var file = input.files && input.files[0]; if(!file) return; var r=new FileReader(); r.onload=function(){ var img=new Image(); img.onload=function(){ var w=Math.min(800,img.width), h=Math.round(img.height*(w/img.width)); var cx=view.x + canvas.width/view.scale/2 - w/2; var cy=view.y + canvas.height/view.scale/2 - h/2; board.elements.push({ id:uid('img'), type:'image', x:cx,y:cy,w:w,h:h,dataURL:r.result }); pushHistory(); draw(); }; img.src=r.result; }; r.readAsDataURL(file); input.value=''; });

    // Export / Import
    document.getElementById('exportPNG').addEventListener('click', function(){ canvas.toBlob(function(b){ var a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='whiteboard.png'; a.click(); setTimeout(function(){ URL.revokeObjectURL(a.href); },1000); }, 'image/png'); });

    document.getElementById('exportSVG').addEventListener('click', function(){ var w=canvas.width,h=canvas.height; var svg='<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" width="'+w+'" height="'+h+'" viewBox="0 0 '+w+' '+h+'">'; function sc(v){return v*view.scale;} function X(x){return (x-view.x)*view.scale;} function Y(y){return (y-view.y)*view.scale;} svg+='<rect width="100%" height="100%" fill="#0b1625"/>';
      for(var i=0;i<board.elements.length;i++){ var el=board.elements[i]; if(el.type==='stroke'||el.type==='highlight'||el.type==='eraser'){ var d=''; for(var j=0;j<el.points.length;j++){ var p=el.points[j]; d+=(j?' L':'M')+X(p.x)+','+Y(p.y); } var col=(el.type==='eraser'?'white':(el.color||'#fff')); var op=(el.type==='highlight'?(el.opacity||0.35):(el.opacity||1)); svg+='<path d="'+d+'" fill="none" stroke="'+col+'" stroke-linecap="round" stroke-linejoin="round" stroke-width="'+sc(el.size)+'" opacity="'+op+'"/>'; }
        if(el.type==='line'){ svg+='<line x1="'+X(el.x1)+'" y1="'+Y(el.y1)+'" x2="'+X(el.x2)+'" y2="'+Y(el.y2)+'" stroke="'+(el.color||'#fff')+'" stroke-width="'+sc(el.size)+'" stroke-linecap="round"/>'; }
        if(el.type==='rect'){ var rx=Math.min(X(el.x1),X(el.x2)), ry=Math.min(Y(el.y1),Y(el.y2)); var rw=Math.abs(X(el.x2)-X(el.x1)), rh=Math.abs(Y(el.y2)-Y(el.y1)); if(el.fill) svg+='<rect x="'+rx+'" y="'+ry+'" width="'+rw+'" height="'+rh+'" fill="'+el.fill+'" opacity="0.18"/>'; svg+='<rect x="'+rx+'" y="'+ry+'" width="'+rw+'" height="'+rh+'" fill="none" stroke="'+(el.color||'#fff')+'" stroke-width="'+sc(el.size)+'"/>'; }
        if(el.type==='text'){ var lines=(el.text||'').split(/
/); for(var j2=0;j2<lines.length;j2++){ svg+='<text x="'+X(el.x)+'" y="'+Y(el.y + j2*((el.size||22)*1.3))+'" font-family="Inter,system-ui,sans-serif" font-size="'+(el.size||22)+'" fill="'+(el.color||'#fff')+'">'+escapeXml(lines[j2])+'</text>'; } }
        if(el.type==='image'){ svg+='<image href="'+el.dataURL+'" x="'+X(el.x)+'" y="'+Y(el.y)+'" width="'+sc(el.w)+'" height="'+sc(el.h)+'" />'; }
        if(el.type==='sticky'){ var sx=X(el.x), sy=Y(el.y), sw=sc(el.w), sh=sc(el.h); svg+='<g transform="translate('+sx+','+sy+')">'; svg+='<rect width="'+sw+'" height="'+sh+'" rx="8" ry="8" fill="'+(el.color||'#fff7a9')+'" stroke="rgba(0,0,0,0.08)"/>'; var pad=10; var lns=(el.text||'').split(/
/); for(var j3=0;j3<lns.length;j3++){ svg+='<text x="'+pad+'" y="'+(pad + j3*20)+'" font-family="Inter,system-ui,sans-serif" font-size="16" fill="#111">'+escapeXml(lns[j3])+'</text>'; } svg+='</g>'; }
      }
      svg+='</svg>'; var blob=new Blob([svg],{type:'image/svg+xml'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='whiteboard.svg'; a.click(); setTimeout(function(){ URL.revokeObjectURL(a.href); },1000);
    });

    document.getElementById('exportJSON').addEventListener('click', function(){ var data=JSON.stringify({bg:board.bg,elements:board.elements},null,2); var a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([data],{type:'application/json'})); a.download='whiteboard.json'; a.click(); setTimeout(function(){ URL.revokeObjectURL(a.href); },1000); });

    document.getElementById('importJSON').addEventListener('change', function(){ var input=document.getElementById('importJSON'); var f = input.files && input.files[0]; if(!f) return; var r=new FileReader(); r.onload=function(){ try{ var obj=JSON.parse(r.result); if(!obj.elements) throw new Error('Invalid whiteboard JSON'); board={ bg:obj.bg||'grid', elements:obj.elements }; imageCache.clear(); pushHistory(); draw(); }catch(e){ alert('Import error: '+e.message); } }; r.readAsText(f); input.value=''; });

    // Status
    function updateStatus(){ var s=$('#status'); if(!s) return; s.textContent = tool.charAt(0).toUpperCase()+tool.slice(1) + ' ‚Ä¢ size ' + size + ' ‚Ä¢ ' + ((opacity*100)|0) + '% ‚Ä¢ zoom ' + view.scale.toFixed(2) + '√ó' + (spaceDown?' ‚Ä¢ (Space: pan)':''); }

    // Init
    $('#bg').value=board.bg||'grid'; resize(); draw(); var st=document.getElementById('status'); if(st) st.textContent='Ready';
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', boot, {once:true});
  } else {
    boot();
  }
})();
</script>
</body>
</html>
