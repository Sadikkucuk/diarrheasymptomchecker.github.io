<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Türkçe Blog Arşivi</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;margin:0;padding:2rem;line-height:1.5}
h1{margin:0 0 1rem}
.controls{display:flex;gap:.5rem;flex-wrap:wrap;margin:0 0 1rem}
input[type="search"]{padding:.6rem .8rem;border:1px solid #ddd;border-radius:.6rem;min-width:240px}
.grid{display:grid;gap:1rem;grid-template-columns:repeat(auto-fill,minmax(280px,1fr))}
.card{border:1px solid #eee;border-radius:.9rem;overflow:hidden;background:#fff;display:flex;flex-direction:column}
.thumb{width:100%;height:180px;object-fit:cover;background:#f6f6f6}
.card-content{padding:.9rem}
.card h2{font-size:1.05rem;margin:.2rem 0 .4rem;line-height:1.3}
.card p{margin:0;color:#555}
.meta{font-size:.85rem;color:#888;margin-top:.4rem}
footer{margin-top:2rem;color:#888;font-size:.85rem}
</style>
</head>
<body>
<h1>Türkçe Blog Arşivi</h1>
<div class="controls">
  <input id="q" type="search" placeholder="Ara (başlık / açıklama)..." />
  <span id="count" class="meta"></span>
</div>
<div id="list" class="grid" aria-live="polite"></div>
<footer>Bu liste otomatik olarak <code>/tr</code> klasöründeki HTML sayfalardan üretilir.</footer>

<script>
// ====== CONFIG ======
const GH = {
  owner: "YOUR_GITHUB_USERNAME",
  repo:  "YOUR_REPO_NAME",
  branch:"main" // or "gh-pages"
};
const FOLDER = "tr";                 // folder that holds your 100 .html files
const LINK_BASE = "/tr/";            // how users will open the page on your site
const LIMIT = 500;                   // safety limit

// ====== Helpers ======
async function ghListDir(path){
  const url = `https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${encodeURIComponent(path)}?ref=${GH.branch}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error(`GitHub API ${res.status}`);
  return res.json();
}
async function fetchPage(pathOnSite){
  // Fetch rendered HTML from your site so we can parse <title>, <meta>, first <img>
  const res = await fetch(pathOnSite, {cache:"no-store"});
  if(!res.ok) throw new Error(`Fetch failed ${res.status}`);
  return res.text();
}
function extractMeta(html){
  const doc = new DOMParser().parseFromString(html, "text/html");
  const title = (doc.querySelector("meta[property='og:title']")?.content
              || doc.querySelector("title")?.textContent
              || doc.querySelector("h1")?.textContent || "").trim();
  const desc  = (doc.querySelector("meta[name='description']")?.content
              || doc.querySelector("p")?.textContent || "").trim();
  const imgEl = doc.querySelector("meta[property='og:image']")?.content
             || doc.querySelector("img")?.getAttribute("src") || "";
  return {title, desc, img: imgEl};
}
function normalizeUrl(base, maybeRelative){
  if(!maybeRelative) return "";
  try{ new URL(maybeRelative); return maybeRelative; }catch{}
  // make relative to the /tr/ page
  if(maybeRelative.startsWith("/")) return maybeRelative;
  return base.replace(/\/+$/,"") + "/" + maybeRelative;
}

// ====== Main ======
const container = document.getElementById("list");
const countEl   = document.getElementById("count");
const searchEl  = document.getElementById("q");
let ALL = [];

async function load(){
  container.innerHTML = "<p>Yükleniyor…</p>";
  try{
    const items = await ghListDir(FOLDER);
    const htmlFiles = items
      .filter(x => x.type === "file" && /\.html?$/i.test(x.name))
      .slice(0, LIMIT);

    // Fetch and parse each page (parallel with throttling)
    const tasks = htmlFiles.map(async f => {
      const link = LINK_BASE + encodeURIComponent(f.name);
      const html = await fetchPage(link);
      const meta = extractMeta(html);
      const img  = normalizeUrl(LINK_BASE, meta.img);
      const dt   = f.name.match(/\d{4}-\d{2}-\d{2}/)?.[0] || ""; // optional date in filename
      return { title: meta.title || f.name.replace(/\.html?$/i,""),
               desc:  meta.desc,
               img, link, file: f.name, date: dt };
    });

    ALL = await Promise.all(tasks);

    // Sort newest by guessed date in filename; fallback by name
    ALL.sort((a,b)=>{
      if(a.date && b.date) return a.date < b.date ? 1 : -1;
      return a.file.localeCompare(b.file);
    });

    render(ALL);
  }catch(e){
    container.innerHTML = `<p>Liste alınamadı: ${e.message}</p>`;
  }
}

function render(list){
  countEl.textContent = `${list.length} yazı`;
  container.innerHTML = list.map(p=>`
    <article class="card">
      <a href="${p.link}">
        ${p.img ? `<img class="thumb" src="${p.img}" alt="${p.title}">` : `<div class="thumb" aria-hidden="true"></div>`}
        <div class="card-content">
          <h2>${escapeHtml(p.title)}</h2>
          ${p.desc ? `<p>${escapeHtml(p.desc)}</p>` : ""}
          ${p.date ? `<div class="meta">${p.date}</div>` : ""}
        </div>
      </a>
    </article>
  `).join("");
}
function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

searchEl.addEventListener("input", e=>{
  const q = e.target.value.trim().toLowerCase();
  if(!q) return render(ALL);
  const filtered = ALL.filter(p =>
    p.title.toLowerCase().includes(q) || p.desc.toLowerCase().includes(q)
  );
  render(filtered);
});

load();
</script>
</body>
</html>
