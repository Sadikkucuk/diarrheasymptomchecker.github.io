<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Türkçe Blog Arşivi</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;margin:0;padding:2rem;line-height:1.5}
h1{margin:0 0 1rem}
.controls{display:flex;gap:.5rem;flex-wrap:wrap;margin:0 0 1rem}
input[type="search"]{padding:.6rem .8rem;border:1px solid #ddd;border-radius:.6rem;min-width:240px}
.grid{display:grid;gap:1rem;grid-template-columns:repeat(auto-fill,minmax(280px,1fr))}
.card{border:1px solid #eee;border-radius:.9rem;overflow:hidden;background:#fff;display:flex;flex-direction:column}
.thumb{width:100%;height:180px;object-fit:cover;background:#f6f6f6}
.card-content{padding:.9rem}
.card h2{font-size:1.05rem;margin:.2rem 0 .4rem;line-height:1.3}
.card p{margin:0;color:#555}
.meta{font-size:.85rem;color:#888;margin-top:.4rem}
footer{margin-top:2rem;color:#888;font-size:.85rem}
</style>
</head>
<body>
<h1>Türkçe Blog Arşivi</h1>
<div class="controls">
  <input id="q" type="search" placeholder="Ara (başlık / açıklama)..." />
  <span id="count" class="meta"></span>
</div>
<div id="list" class="grid" aria-live="polite"></div>
<footer>Bu liste otomatik olarak <code>/tr</code> klasöründeki HTML sayfalardan üretilir.</footer>

<script>
const LINK_BASE = "/tr/";           // sitende /tr/ sayfalarına böyle gidiyoruz
const LIMIT = 1000;

// ---- OWNER/REPO otomatik tespit (user.github.io/repo/... veya user.github.io/...) ----
function guessOwnerRepo(){
  const host = location.hostname;          // sadik-kucuk3739342.github.io
  const path1 = location.pathname.split("/").filter(Boolean); // ["my-repo", "tr", "arsiv.html"]
  const owner = host.split(".")[0];        // "sadik-kucuk3739342"
  const repo  = (host.endsWith(".github.io") && path1.length>0) ? path1[0] : `${owner}.github.io`;
  return { owner, repo };
}

// ---- GitHub API yardımcıları ----
async function ghListDir(owner, repo, branch, path){
  const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${branch}`;
  const r = await fetch(url);
  if (!r.ok) throw new Error(`GitHub API ${r.status} ${branch}/${path}`);
  return r.json();
}
async function fetchPage(pathOnSite){
  const r = await fetch(pathOnSite, { cache: "no-store" });
  if (!r.ok) throw new Error(`Fetch ${r.status} ${pathOnSite}`);
  return r.text();
}
function extractMeta(html){
  const doc = new DOMParser().parseFromString(html, "text/html");
  const title = (doc.querySelector("meta[property='og:title']")?.content
              || doc.querySelector("title")?.textContent
              || doc.querySelector("h1")?.textContent || "").trim();
  const desc  = (doc.querySelector("meta[name='description']")?.content
              || doc.querySelector("p")?.textContent || "").trim();
  const img   = (doc.querySelector("meta[property='og:image']")?.content
              || doc.querySelector("img")?.getAttribute("src") || "");
  return { title, desc, img };
}
function normalizeUrl(base, maybeRelative){
  if (!maybeRelative) return "";
  try { new URL(maybeRelative); return maybeRelative; } catch {}
  if (maybeRelative.startsWith("/")) return maybeRelative;
  return base.replace(/\/+$/,"") + "/" + maybeRelative;
}

// ---- UI ----
const container = document.getElementById("list");
const countEl   = document.getElementById("count");
const searchEl  = document.getElementById("q");
let ALL = [];

function render(list){
  countEl.textContent = `${list.length} yazı`;
  container.innerHTML = list.map(p=>`
    <article class="card">
      <a href="${p.link}">
        ${p.img ? `<img class="thumb" src="${p.img}" alt="${p.title}">` : `<div class="thumb" aria-hidden="true"></div>`}
        <div class="card-content">
          <h2>${p.title.replace(/[&<>"]/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;", '"':"&quot;" }[m]))}</h2>
          ${p.desc ? `<p>${p.desc}</p>` : ""}
          ${p.date ? `<div class="meta">${p.date}</div>` : ""}
        </div>
      </a>
    </article>
  `).join("");
}

searchEl?.addEventListener("input", e=>{
  const q = e.target.value.trim().toLowerCase();
  if(!q) return render(ALL);
  const filtered = ALL.filter(p =>
    p.title.toLowerCase().includes(q) || p.desc.toLowerCase().includes(q)
  );
  render(filtered);
});

// ---- Ana akış: birkaç kombinasyonu dener ----
(async ()=>{
  container.innerHTML = "<p>Yükleniyor…</p>";

  const { owner, repo } = guessOwnerRepo();
  const branches = ["gh-pages", "main", "master"];
  const paths    = ["tr", "docs/tr"];

  let files = null, ok = null;
  for (const br of branches){
    for (const p of paths){
      try {
        const list = await ghListDir(owner, repo, br, p);
        files = list.filter(x => x.type==="file" && /\.html?$/i.test(x.name));
        ok = { owner, repo, branch: br, folder: p };
        break;
      } catch(e) {
        // 404 ise diğer kombinasyonu dene
      }
    }
    if (ok) break;
  }

  if (!ok){
    container.innerHTML = `<p>Liste alınamadı: GitHub API 404 (owner/repo/branch/klasör uyuşmuyor veya repo private)</p>
    <ul class="muted">
      <li>Repo public mi?</li>
      <li>Dosyalar hangi branch'te? (gh-pages / main / master)</li>
      <li>Klasör yolu doğru mu? (<code>/tr</code> mi, yoksa <code>/docs/tr</code> mi?)</li>
    </ul>`;
    return;
  }

  const items = await Promise.all(files.map(async f=>{
    const link = LINK_BASE + encodeURIComponent(f.name);
    const html = await fetchPage(link);
    const meta = extractMeta(html);
    const img  = normalizeUrl(LINK_BASE, meta.img);
    const dt   = f.name.match(/\d{4}-\d{2}-\d{2}/)?.[0] || "";
    return { title: meta.title || f.name.replace(/\.html?$/i,""),
             desc: meta.desc || "",
             img, link, file: f.name, date: dt };
  }));

  ALL = items.sort((a,b)=>{
    if (a.date && b.date) return a.date < b.date ? 1 : -1;
    return a.file.localeCompare(b.file);
  });
  render(ALL);
})();
</script>

</body>
</html>
